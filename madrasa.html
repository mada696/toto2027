<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฅุฏุงุฑุฉ ุงููุฏุฑุณุฉ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #141A32; min-height: 100vh; color: #E8EDEB; padding-bottom: 20px; padding-top: 50px; overflow-x: hidden; }
        .glass-panel { background: rgba(20, 26, 50, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(214, 140, 41, 0.3); border-radius: 1.5rem; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); }
        .input-light { background-color: #ffffff !important; color: #1e293b !important; border: 2px solid #cbd5e1; font-weight: 800; transition: all 0.3s ease;}
        .input-light:focus { border-color: #D68C29; outline: none; box-shadow: 0 0 0 3px rgba(214, 140, 41, 0.3); }
        .input-readonly { background-color: #f1f5f9 !important; color: #64748b !important; border: 1px solid #e2e8f0; cursor: not-allowed; font-weight: 900 !important; }
        label { font-size: 0.85rem; font-weight: bold; color: #D68C29; margin-bottom: 0.4rem; display: block; }
        .btn-gold { background: linear-gradient(135deg, #D68C29 0%, #B4731D 100%); color: white; border: none; box-shadow: 0 5px 15px rgba(214, 140, 41, 0.3); transition: all 0.3s;}
        .btn-gold:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(214, 140, 41, 0.5); }
        
        .main-card { background: linear-gradient(145deg, rgba(30,41,59,0.9), rgba(15,23,42,0.9)); border: 2px solid rgba(255,255,255,0.05); border-radius: 20px; padding: 20px 15px; text-align: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.3);}
        .main-card:hover { transform: translateY(-8px); border-color: #D68C29; box-shadow: 0 15px 30px rgba(214, 140, 41, 0.2); background: linear-gradient(145deg, rgba(30,41,59,1), rgba(20,26,50,1));}
        .icon-wrapper { width: 55px; height: 55px; border-radius: 50%; background: rgba(214, 140, 41, 0.1); display: flex; align-items: center; justify-content: center; color: #F5C678; transition: all 0.3s; }
        .main-card:hover .icon-wrapper { background: #D68C29; color: #141A32; transform: scale(1.1); }
        
        .home-btn { display: inline-flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.1); color: white; padding: 8px 20px; border-radius: 50px; font-weight: bold; border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s; margin-bottom: 20px; text-decoration: none;}
        .home-btn:hover { background: #D68C29; border-color: #D68C29; color: #141A32; box-shadow: 0 5px 15px rgba(214, 140, 41, 0.4); transform: translateX(-5px);}
        
        .avatar-upload-wrapper { position: relative; width: 100px; height: 100px; margin: 0 auto; border-radius: 50%; overflow: hidden; border: 3px solid #D68C29; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3);}
        .avatar-upload-wrapper img { width: 100%; height: 100%; object-fit: cover; background: #fff;}
        .avatar-upload-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; font-size: 12px; font-weight: bold; padding: 6px 0; text-align: center; opacity: 0; transition: 0.3s;}
        .avatar-upload-wrapper:hover .avatar-upload-overlay { opacity: 1; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #8b5cf6; border-radius: 10px; }

        [x-cloak] { display: none !important; }
    </style>
</head>

<body x-data="madrasaApp()" x-init="initApp()">

    <div x-show="showAgentDetailsModal" class="fixed inset-0 z-[100000] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" x-cloak x-transition>
        <div class="bg-[#141A32] w-full max-w-lg p-6 rounded-3xl border-t-8 border-cyan-500 shadow-2xl relative overflow-hidden">
            <button @click="showAgentDetailsModal = false; selectedAgent = null" class="absolute top-4 left-4 text-slate-400 hover:text-white bg-slate-800 rounded-full w-8 h-8 flex items-center justify-center transition-colors">โ</button>
            <h3 class="text-xl font-black text-white mb-6 text-center border-b border-white/10 pb-3">ุงูุณุฌู ุงููุธููู ูููููู</h3>
            
            <template x-if="selectedAgent">
                <div class="space-y-4">
                    <div class="flex items-center gap-4 bg-black/30 p-4 rounded-2xl border border-white/5 shadow-inner">
                        <img :src="selectedAgent.avatar_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" class="w-20 h-20 rounded-xl border-2 border-cyan-500 object-cover bg-white shadow-md">
                        <div>
                            <h4 class="text-xl font-black text-cyan-400 leading-tight" x-text="selectedAgent.full_name || 'ุจุงูุชุธุงุฑ ุงูุชุณุฌูู'"></h4>
                            <p class="text-slate-400 font-mono text-sm mt-1" x-text="selectedAgent.mobile"></p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="bg-[#0B0F1E] p-3 rounded-xl border border-white/5">
                            <span class="text-slate-500 block text-[10px] font-bold mb-1">ุงูุฑูู ุงููููู</span>
                            <span class="text-yellow-400 font-mono tracking-widest font-bold" x-text="selectedAgent.nid || '---'"></span>
                        </div>
                        <div class="bg-[#0B0F1E] p-3 rounded-xl border border-white/5">
                            <span class="text-slate-500 block text-[10px] font-bold mb-1">ุชุงุฑูุฎ ุงููููุงุฏ</span>
                            <span class="text-white font-bold" x-text="selectedAgent.dob || '---'"></span>
                        </div>
                        <div class="bg-[#0B0F1E] p-3 rounded-xl border border-white/5">
                            <span class="text-slate-500 block text-[10px] font-bold mb-1">ุชุงุฑูุฎ ุงูุชุนููู</span>
                            <span class="text-white font-bold" x-text="selectedAgent.hiring_date || '---'"></span>
                        </div>
                        <div class="bg-[#0B0F1E] p-3 rounded-xl border border-white/5">
                            <span class="text-slate-500 block text-[10px] font-bold mb-1">ุงุณุชูุงู ุงูุนูู</span>
                            <span class="text-white font-bold" x-text="selectedAgent.job_assumption_date || '---'"></span>
                        </div>
                        <div class="bg-green-500/10 p-3 rounded-xl border border-green-500/30">
                            <span class="text-green-500 block text-[10px] font-bold mb-1">ุชุงุฑูุฎ ุงูุชุฌุฏูุฏ</span>
                            <span class="text-green-400 font-black" x-text="selectedAgent.renewal_date || '---'"></span>
                        </div>
                        <div class="bg-red-500/10 p-3 rounded-xl border border-red-500/30">
                            <span class="text-red-500 block text-[10px] font-bold mb-1">ุชุงุฑูุฎ ุงูุชูุงุนุฏ</span>
                            <span class="text-red-400 font-black" x-text="selectedAgent.retirement_date || '---'"></span>
                        </div>
                        <div class="col-span-2 bg-[#0B0F1E] p-4 rounded-xl border border-white/5 flex justify-between items-center">
                            <div>
                                <span class="text-slate-500 block text-[10px] font-bold mb-1">ุทุจูุนุฉ ุงูุชูููู</span>
                                <span class="text-cyan-300 font-bold text-lg" x-text="selectedAgent.agent_assignment || 'ุจุฏูู ุชูููู'"></span>
                            </div>
                            <div class="text-left border-r border-white/10 pr-4">
                                <span class="text-slate-500 block text-[10px] font-bold mb-1">ุงููููู ุงููุงูู</span>
                                <span :class="selectedAgent.job_status === 'ูุนูู ุจูุฑุงุฑ' ? 'text-green-400' : 'text-orange-400'" class="font-bold text-lg" x-text="selectedAgent.job_status || 'ูู ูุญุฏุฏ'"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <div x-show="alertModal.show" class="fixed inset-0 z-[99999] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" x-cloak x-transition><div class="bg-white w-full max-w-sm p-8 rounded-3xl shadow-2xl text-center transform transition-all" :class="alertModal.type === 'success' ? 'border-t-8 border-green-500' : 'border-t-8 border-red-500'"><div class="text-6xl mb-4" x-text="alertModal.type === 'success' ? 'โ' : 'โ๏ธ'"></div><h3 class="text-2xl font-black text-slate-800 mb-2" x-text="alertModal.title"></h3><p class="text-slate-600 font-bold mb-6 text-sm" x-text="alertModal.message"></p><button @click="closeAlert()" :class="`btn w-full text-white font-black text-lg h-12 rounded-xl border-none ${alertModal.type === 'success' ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'}`">ุญุณูุงู</button></div></div>
    
    <div x-show="showOathModal" class="fixed inset-0 z-[100000] flex items-center justify-center bg-black/90 backdrop-blur-md p-4" x-cloak x-transition><div class="bg-[#141A32] w-full max-w-md p-8 rounded-3xl shadow-[0_0_40px_rgba(214,140,41,0.3)] border border-[#D68C29]/50 text-center relative overflow-hidden"><div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-red-500 via-yellow-500 to-red-500"></div><div class="w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-red-500/50 text-4xl">โ๏ธ</div><h3 class="text-2xl font-black text-white mb-4">ุฅูุฑุงุฑ ูุงูููู</h3><div class="bg-black/40 p-5 rounded-xl border border-white/10 mb-6"><p class="text-slate-300 font-bold leading-loose text-sm md:text-base">"ุฃุชุนูุฏ ุฃูุง <span class="text-[#F5C678] font-black mx-1" x-text="formData.full_name"></span> ุจุฃู ุฌููุน ุงูุจูุงูุงุช ุงูููุฏุฎูุฉ ูุงููุญููุธุฉ ูู ูุฐุง ุงูุณุฌู ุตุญูุญุฉ ูุฏูููุฉ ููุทุงุจูุฉ ูููุณุชูุฏุงุช ุงูุฑุณููุฉุ ูุนูู ูุณุฆูููุชู ุงูุดุฎุตูุฉ ูุงููุงููููุฉ ุจุงููุงูู."</p></div><div class="flex gap-3"><button @click="confirmAndSave()" class="btn flex-1 bg-green-600 hover:bg-green-700 text-white font-black text-lg h-14 rounded-xl border-none shadow-lg">ุฃูุงูู ูุฃุชุนูุฏ โ</button><button @click="showOathModal = false" class="btn bg-slate-700 hover:bg-slate-600 text-white font-black text-lg h-14 rounded-xl border-none">ุชุฑุงุฌุน โ</button></div></div></div>

    <div class="w-full p-4 flex justify-between items-center bg-[#141A32]/90 backdrop-blur sticky top-0 z-40 border-b border-[#D68C29]/30 shadow-lg">
        <div><p class="text-xs text-slate-400">ููุญุฉ ุชุญูู ูุฏุฑุณุฉ:</p><h1 class="text-xl md:text-2xl font-black text-[#D68C29]" x-text="school.name || 'ุฌุงุฑู ุงูุชุญููู...'"></h1></div>
        <div class="text-left">
            <span class="badge bg-slate-700 text-white border-none text-xs mb-1 px-3 py-2" x-text="currentUser?.role === 'manager' ? '๐ ูุฏูุฑ ุงููุฏุฑุณุฉ' : '๐จโ๐ซ ูููู'"></span>
            <button @click="logout" class="block text-red-400 font-bold text-sm hover:text-red-300 w-full text-left mt-1">ุฎุฑูุฌ ๐ช</button>
        </div>
    </div>

    <div class="p-4 max-w-4xl mx-auto min-h-[80vh] mt-4 relative">

        <div x-show="currentView === 'menu'" x-transition.opacity x-cloak>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">
                <div x-show="currentUser?.role === 'manager'" @click="openManagerView()" class="main-card relative">
                    <span x-show="!managerData.full_name" class="absolute top-3 right-3 flex h-4 w-4"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-4 w-4 bg-red-500"></span></span>
                    <div class="icon-wrapper"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg></div>
                    <div><h2 class="text-lg font-black text-white">ุจูุงูุงุช ุงููุฏูุฑ</h2><p class="text-[10px] text-slate-400 mt-1">ุงูุณุฌู ุงููุธููู</p></div>
                </div>
                
                <div x-show="currentUser?.role === 'manager'" @click="currentView = 'agents'" class="main-card">
                    <div class="icon-wrapper"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>
                    <div><h2 class="text-lg font-black text-white">ุฅุฏุงุฑุฉ ุงููููุงุก</h2><p class="text-[10px] text-slate-400 mt-1">ุฅุถุงูุฉ ูุญุฐู</p></div>
                </div>

                <div x-show="currentUser?.role === 'manager'" @click="currentView = 'agent_records'" class="main-card bg-gradient-to-br from-cyan-900/50 to-[#141A32]">
                    <div class="icon-wrapper !bg-cyan-500/20 !text-cyan-400"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div>
                    <div><h2 class="text-lg font-black text-cyan-400">ูููุงุช ุงููููุงุก</h2><p class="text-[10px] text-slate-400 mt-1">ุนุฑุถ ุงูุณุฌู ุงููุธููู</p></div>
                </div>
                
                <div x-show="currentUser?.role === 'agent'" @click="openAgentProfile()" class="main-card relative">
                    <span x-show="!currentUser?.full_name || currentUser?.full_name === 'ุจุงูุชุธุงุฑ ุงุณุชููุงู ุงูุจูุงูุงุช'" class="absolute top-3 right-3 flex h-4 w-4"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-4 w-4 bg-red-500"></span></span>
                    <div class="icon-wrapper"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div>
                    <div><h2 class="text-lg font-black text-white">ุจูุงูุงุชู ุงููุธูููุฉ</h2><p class="text-[10px] text-slate-400 mt-1">ุชุญุฏูุซ ุณุฌูู</p></div>
                </div>

                <div @click="currentView = 'statistics'" class="main-card">
                    <div class="icon-wrapper"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg></div>
                    <div><h2 class="text-lg font-black text-white">ุงูุฅุญุตุงุก ุงูุดุงูู</h2><p class="text-[10px] text-slate-400 mt-1">ุงูุนุงูููู ูุงูุทูุงุจ ูุงููุตูู</p></div>
                </div>

                <div x-show="currentUser?.role === 'manager'" @click="currentView = 'archive'; fetchArchive()" class="main-card bg-gradient-to-r from-emerald-900/50 to-[#141A32]">
                    <div class="icon-wrapper !bg-emerald-500/20 !text-emerald-400"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg></div>
                    <div><h2 class="text-lg font-black text-emerald-400">ุฃุฑุดูู ุงููุฏุฑุณุฉ</h2><p class="text-[10px] text-slate-400 mt-1">ุญูุธ ุงููุณุชูุฏุงุช ุงููุงูุฉ</p></div>
                </div>

                <div @click="currentView = 'messages'" class="main-card relative">
                    <span x-show="schoolMessages.length > 0" class="absolute top-3 right-3 bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full animate-pulse shadow-lg border border-white" x-text="schoolMessages.length"></span>
                    <div class="icon-wrapper"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg></div>
                    <div><h2 class="text-lg font-black text-white">ุงูุชุนูููุงุช ุงููุงุฑุฏุฉ</h2><p class="text-[10px] text-slate-400 mt-1">ุตูุฏูู ุงููุฑุงุณูุงุช</p></div>
                </div>

                <div @click="currentView = 'requests'" class="main-card md:col-span-2">
                    <div class="icon-wrapper"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg></div>
                    <div><h2 class="text-lg font-black text-white">ุฅุฑุณุงู ุทูุจ ููุชูุณูู</h2><p class="text-[10px] text-slate-400 mt-1">ุฑูุน ุงููููุงุช ูุงูุฅูุฑุงุฑุงุช ุงููุทููุจุฉ</p></div>
                </div>
            </div>
        </div>

        <div x-show="currentView === 'agent_records'" x-transition x-cloak>
            <div class="flex justify-between items-center mb-4">
                <button @click="currentView = 'menu'" class="home-btn mb-0"><svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg> ุงูุฑุฆูุณูุฉ</button>
                <button @click="fetchAgents()" class="btn btn-sm btn-ghost text-cyan-400 border border-cyan-500/30">
                    <span x-show="!loadingAgents">๐ ุชุญุฏูุซ ุงููุงุฆูุฉ</span>
                    <span x-show="loadingAgents" class="loading loading-spinner loading-xs"></span>
                </button>
            </div>
            <div class="glass-panel p-6 border-t-4 border-t-cyan-500">
                <h2 class="text-2xl font-black text-white text-center mb-8 flex items-center justify-center gap-2"><span>๐</span> ุงูุณุฌูุงุช ุงููุธูููุฉ ูููููุงุก</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <template x-for="(agent, i) in schoolAgents" :key="i + 'rec'">
                        <div class="bg-black/30 p-5 rounded-2xl border border-cyan-500/20 flex flex-col justify-between items-center gap-4 hover:border-cyan-500/50 transition-colors">
                            <div class="flex items-center gap-4 w-full">
                                <img :src="agent.avatar_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" class="w-16 h-16 rounded-full border-2 border-cyan-500 object-cover bg-white">
                                <div>
                                    <h3 class="text-lg font-bold text-white leading-tight" x-text="agent.full_name || 'ุจุงูุชุธุงุฑ ุงุณุชููุงู ุงูุจูุงูุงุช'"></h3>
                                    <span class="text-xs text-cyan-400 font-bold" x-text="agent.agent_assignment || 'ุจุฏูู ุชูููู'"></span>
                                </div>
                            </div>
                            <button @click="viewAgentDetails(agent)" class="btn w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold border-none rounded-xl">ุนุฑุถ ุงูููู ุงููุธููู ๐๏ธ</button>
                        </div>
                    </template>
                </div>
                <div x-show="schoolAgents.length === 0 && !loadingAgents" class="text-center py-8 opacity-50">
                    <span class="text-5xl block mb-2 grayscale">๐ฅ</span>
                    <p class="text-slate-300 font-bold text-lg">ูุง ููุฌุฏ ูููุงุก ูุณุฌููู ุญุงููุงู ุจุงููุฏุฑุณุฉ.</p>
                </div>
            </div>
        </div>

        <div x-show="currentView === 'agents'" x-transition x-cloak>
            <div class="flex justify-between items-center mb-4">
                <button @click="currentView = 'menu'" class="home-btn mb-0"><svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg> ุงูุฑุฆูุณูุฉ</button>
                <button @click="fetchAgents()" class="btn btn-sm btn-ghost text-blue-400 border border-blue-500/30">
                    <span x-show="!loadingAgents">๐ ุชุญุฏูุซ ุงููุงุฆูุฉ</span>
                    <span x-show="loadingAgents" class="loading loading-spinner loading-xs"></span>
                </button>
            </div>
            <div class="glass-panel p-6 border-t-4 border-t-blue-500">
                <h2 class="text-2xl font-black text-white text-center mb-6">โ๏ธ ุฅุฏุงุฑุฉ ุงููููุงุก (ุฅุถุงูุฉ / ุฅุฒุงูุฉ)</h2>
                
                <div class="bg-black/30 p-5 rounded-2xl border border-white/10 mb-8">
                    <label class="mb-2 block text-[#D68C29] text-sm font-bold">ุฅุถุงูุฉ ูููู ุฌุฏูุฏ ุจุฑูู ุงูููุจุงูู</label>
                    <div class="flex flex-col md:flex-row gap-3">
                        <input type="tel" x-model="newAgentMobile" maxlength="11" placeholder="01xxxxxxxxx" class="input w-full input-light rounded-xl h-14 text-center text-xl font-mono tracking-widest">
                        <button @click="addNewAgent()" class="btn btn-success text-white border-none rounded-xl h-14 px-8 shadow-lg font-black text-lg">
                            <span x-show="!loadingAgents">ุฅุถุงูุฉ โ</span>
                            <span x-show="loadingAgents" class="loading loading-spinner"></span>
                        </button>
                    </div>
                </div>

                <div class="space-y-4">
                    <template x-for="(agent, i) in schoolAgents" :key="i + 'mgmt'">
                        <div class="bg-gradient-to-l from-slate-800 to-[#141A32] p-4 rounded-2xl border border-white/10 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div class="flex items-center gap-4 w-full md:w-auto">
                                <div class="w-10 h-10 bg-blue-500/20 text-blue-400 rounded-full flex items-center justify-center font-bold text-lg border border-blue-500/30 overflow-hidden">
                                    <template x-if="agent.avatar_url"><img :src="agent.avatar_url" class="w-full h-full object-cover"></template>
                                    <template x-if="!agent.avatar_url"><span x-text="i + 1"></span></template>
                                </div>
                                <div>
                                    <h3 class="text-base font-bold text-white leading-tight" x-text="agent.full_name || 'ุจุงูุชุธุงุฑ ุงูุชุณุฌูู'"></h3>
                                    <p class="text-blue-300 font-mono text-xs mt-1" x-text="agent.mobile"></p>
                                </div>
                            </div>
                            <button @click="removeAgent(agent.mobile)" class="btn btn-sm btn-error text-white border-none shadow w-full md:w-auto">ุฅุฒุงูุฉ ุงููููู ๐๏ธ</button>
                        </div>
                    </template>
                    <div x-show="schoolAgents.length === 0 && !loadingAgents" class="text-center py-8 opacity-50">
                        <p class="text-slate-300 font-bold text-lg">ูุง ููุฌุฏ ูููุงุก ูุณุฌููู.</p>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="currentView === 'archive'" x-transition x-cloak>
            <button @click="currentView = 'menu'" class="home-btn"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg> ุงูุฑุฆูุณูุฉ</button>
            <div class="glass-panel p-6 border-t-4 border-t-emerald-500">
                <h2 class="text-2xl font-black text-white mb-6">๐๏ธ ุฃุฑุดูู ุงููุฏุฑุณุฉ (ุฎุงุต ุจุงููุฏูุฑ)</h2>
                
                <div class="bg-black/30 p-5 rounded-2xl border border-white/10 mb-8">
                    <h3 class="text-emerald-400 font-bold mb-3">ุฅุถุงูุฉ ูุณุชูุฏ ููุฃุฑุดูู</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-white mb-1 block">ุนููุงู ุงููุณุชูุฏ / ุงููุฑุงุฑ</label>
                            <input type="text" x-model="newArchive.title" class="input w-full input-light h-12" placeholder="ูุซุงู: ูุดุฑุฉ ุชุฑููุงุช 2026">
                        </div>
                        <div>
                            <label class="text-xs text-white mb-1 block">ุฅุฑูุงู ุงูููู (ุตูุฑุฉ ุฃู PDF)</label>
                            <input type="file" @change="e => newArchive.file = e.target.files[0]" class="file-input file-input-bordered w-full bg-white text-black h-12">
                        </div>
                    </div>
                    <button @click="saveToArchive" class="btn w-full mt-4 bg-emerald-600 hover:bg-emerald-700 text-white font-black border-none h-12">
                        <span x-show="!loading">ุญูุธ ูู ุงูุฃุฑุดูู ๐พ</span><span x-show="loading" class="loading loading-spinner"></span>
                    </button>
                </div>

                <h3 class="text-white font-bold mb-4 border-b border-white/10 pb-2">ุงููุณุชูุฏุงุช ุงููุญููุธุฉ</h3>
                <div class="space-y-3 max-h-[50vh] overflow-y-auto pr-2 custom-scrollbar">
                    <template x-for="item in archiveList" :key="item.id">
                        <div class="bg-[#141A32] p-4 rounded-xl border border-emerald-500/30 flex justify-between items-center">
                            <div>
                                <h4 class="font-bold text-[#F5C678]" x-text="item.title"></h4>
                                <span class="text-[10px] text-slate-400" x-text="new Date(item.created_at).toLocaleDateString('ar-EG')"></span>
                            </div>
                            <div class="flex gap-2">
                                <template x-if="item.file_url">
                                    <a :href="item.file_url" target="_blank" class="btn btn-sm btn-ghost text-emerald-400 border border-emerald-500/50">ุนุฑุถ ๐๏ธ</a>
                                </template>
                                <button @click="deleteArchive(item.id)" class="btn btn-sm btn-ghost text-red-500">ุญุฐู ๐๏ธ</button>
                            </div>
                        </div>
                    </template>
                    <div x-show="archiveList.length === 0" class="text-center py-10 text-slate-500 font-bold">ุงูุฃุฑุดูู ูุงุฑุบ ุญุงููุงู.</div>
                </div>
            </div>
        </div>

        <div x-show="currentView === 'statistics'" x-transition x-cloak>
            <div class="flex justify-between items-center mb-4">
                <button @click="currentView = 'menu'" class="home-btn mb-0"><svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg> ุงูุฑุฆูุณูุฉ</button>
            </div>
            <div class="glass-panel p-6 border-t-4 border-t-cyan-500">
                <h2 class="text-2xl font-black text-white text-center mb-8">๐ ุฅุญุตุงุก ุงููุฏุฑุณุฉ ุงูุดุงูู</h2>
                
                <div class="space-y-6">
                    <div class="bg-black/20 p-5 rounded-2xl border border-white/10">
                        <h3 class="text-[#D68C29] font-black mb-4 border-b border-white/10 pb-2 flex items-center gap-2"><span>๐ฅ</span> ุฅุญุตุงุฆูุฉ ููุฉ ุงูุนูู</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-[#141A32] p-3 rounded-xl border border-indigo-500/30 text-center">
                                <label class="text-indigo-400 font-bold block mb-1 text-xs">ุนุฏุฏ ุงููุนูููู</label>
                                <input type="number" x-model="school.teachers_count" class="input w-full input-light h-12 text-center font-black text-lg" :disabled="currentUser?.role !== 'manager'">
                            </div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-teal-500/30 text-center">
                                <label class="text-teal-400 font-bold block mb-1 text-xs">ุนุฏุฏ ุงูุฅุฏุงุฑููู</label>
                                <input type="number" x-model="school.admins_count" class="input w-full input-light h-12 text-center font-black text-lg" :disabled="currentUser?.role !== 'manager'">
                            </div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-amber-500/30 text-center">
                                <label class="text-amber-400 font-bold block mb-1 text-xs">ุงูุนูุงู / ุงูุฎุฏูุงุช</label>
                                <input type="number" x-model="school.workers_count" class="input w-full input-light h-12 text-center font-black text-lg" :disabled="currentUser?.role !== 'manager'">
                            </div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-blue-500/30 text-center">
                                <label class="text-blue-400 font-bold block mb-1 text-xs">ุนุฏุฏ ุงููููุงุก</label>
                                <div class="h-12 flex items-center justify-center font-black text-2xl text-white bg-blue-900/20 rounded-lg" x-text="schoolAgents.length"></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-black/20 p-5 rounded-2xl border border-white/10">
                        <h3 class="text-[#D68C29] font-black mb-4 border-b border-white/10 pb-2">ุงูููุงูู ุงููุธูููุฉ ููููุงุฏุฉ</h3>
                        <table class="w-full text-right text-white space-y-2 border-separate border-spacing-y-3 text-sm md:text-base">
                            <tbody>
                                <tr>
                                    <td class="w-1/2 font-bold bg-white/5 p-3 rounded-r-xl border-r-4 border-r-[#D68C29]">ูููู ูุฏูุฑ ุงููุฏุฑุณุฉ</td>
                                    <td class="w-1/2 p-1 bg-white/5 rounded-l-xl">
                                        <select x-model="school.manager_status" class="select w-full input-light bg-white text-black font-bold h-12" :disabled="currentUser?.role !== 'manager'">
                                            <option value="" disabled selected>ุญุฏุฏ ุงููููู...</option>
                                            <option value="ูุนูู ุจูุฑุงุฑ">ูุนูู ุจูุฑุงุฑ</option>
                                            <option value="ูููู">ูููู</option>
                                        </select>
                                    </td>
                                </tr>
                                <template x-for="(agent, i) in schoolAgents" :key="i + 'stat'">
                                    <tr>
                                        <td class="w-1/2 font-bold bg-white/5 p-3 rounded-r-xl border-r-4 border-r-blue-500 flex items-center gap-2">
                                            <img :src="agent.avatar_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" class="w-8 h-8 rounded-full object-cover bg-white">
                                            <span x-text="`ูููู: ${agent.full_name?.split(' ')[0] || '---'} (${agent.agent_assignment || 'ุจุฏูู'})`"></span>
                                        </td>
                                        <td class="w-1/2 p-1 bg-white/5 rounded-l-xl">
                                            <select x-model="agent.job_status" @change="updateAgentStatus(agent.mobile, agent.job_status)" class="select w-full input-light bg-white text-black font-bold h-12" :disabled="currentUser?.role !== 'manager'">
                                                <option value="" disabled selected>ุญุฏุฏ ุงููููู...</option>
                                                <option value="ูุนูู ุจูุฑุงุฑ">ูุนูู ุจูุฑุงุฑ</option>
                                                <option value="ูููู">ูููู</option>
                                            </select>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <div class="bg-black/20 p-5 rounded-2xl border border-white/10">
                        <h3 class="text-[#D68C29] font-black mb-4 border-b border-white/10 pb-2">ุงูุฃุนุฏุงุฏ ูุงููุซุงูุงุช</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-[#141A32] p-4 rounded-xl border border-blue-500/30 text-center">
                                <label class="text-blue-400 font-bold block mb-2">ุฅุฌูุงูู ุงูุจููู ๐ฆ</label>
                                <input type="number" x-model="school.students_count" class="input w-full input-light h-14 text-center font-black text-xl" :disabled="currentUser?.role !== 'manager'">
                            </div>
                            <div class="bg-[#141A32] p-4 rounded-xl border border-pink-500/30 text-center">
                                <label class="text-pink-400 font-bold block mb-2">ุฅุฌูุงูู ุงูุจูุงุช ๐ง</label>
                                <input type="number" x-model="school.female_students_count" class="input w-full input-light h-14 text-center font-black text-xl" :disabled="currentUser?.role !== 'manager'">
                            </div>
                            <div class="bg-[#141A32] p-4 rounded-xl border border-purple-500/30 text-center">
                                <label class="text-purple-400 font-bold block mb-2">ุนุฏุฏ ุงููุตูู ๐ช</label>
                                <input type="number" x-model="school.classrooms_count" class="input w-full input-light h-14 text-center font-black text-xl" :disabled="currentUser?.role !== 'manager'">
                            </div>
                        </div>
                    </div>

                    <div x-show="currentUser?.role === 'manager'" class="pt-4">
                        <button @click="exportStatsToAdmin" class="btn w-full h-16 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-black text-2xl rounded-2xl shadow-[0_10px_25px_rgba(8,145,178,0.4)] border-none">
                            <span x-show="!sendingReport">ุฅุฑุณุงู ุงูุฅุญุตุงุก ููุชูุณูู ๐ค</span>
                            <span x-show="sendingReport" class="loading loading-spinner"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="currentView === 'manager'" x-transition x-cloak>
            <button @click="currentView = 'menu'; isEditingForm = false" class="home-btn">ุงูุฑุฆูุณูุฉ</button>
            <div class="glass-panel p-6 border-t-4 border-t-[#D68C29]">
                <div x-show="!isEditingForm">
                    <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
                        <h2 class="text-2xl font-black text-white">ุงูุณุฌู ุงููุธููู ูููุฏูุฑ</h2>
                        <button x-show="!managerData.full_name" @click="isEditingForm = true" class="btn btn-sm btn-success text-white border-none animate-pulse">ุชุณุฌูู ุจูุงูุงุชู</button>
                        <button x-show="managerData.full_name" @click="isEditingForm = true" class="btn btn-sm bg-[#D68C29]/20 text-[#D68C29] hover:bg-[#D68C29] hover:text-white border-none">ุชุนุฏูู โ๏ธ</button>
                    </div>
                    <div class="bg-black/20 p-5 rounded-2xl border border-white/5 space-y-4">
                        <div class="flex items-center gap-4 pb-4 border-b border-white/10">
                            <img :src="managerData.avatar_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" class="w-20 h-20 rounded-full border-4 border-[#D68C29] object-cover bg-white">
                            <div>
                                <h3 class="text-xl font-black text-[#F5C678]" x-text="managerData.full_name || 'ูู ูุชู ุงูุชุณุฌูู ุจุนุฏ'"></h3>
                                <p class="text-slate-400 font-mono mt-1" x-text="managerData.mobile || '---'"></p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm md:text-base">
                            <div class="bg-[#141A32] p-3 rounded-xl border border-white/5"><span class="text-slate-500 block mb-1">ุงูุฑูู ุงููููู</span><span class="text-yellow-400 font-mono font-bold" x-text="managerData.nid || '---'"></span></div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-white/5"><span class="text-slate-500 block mb-1">ุชุงุฑูุฎ ุงููููุงุฏ</span><span class="text-white font-bold" x-text="managerData.dob || '---'"></span></div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-white/5"><span class="text-slate-500 block mb-1">ุชุงุฑูุฎ ุงูุชุนููู</span><span class="text-white font-bold" x-text="managerData.hiring_date || '---'"></span></div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-white/5"><span class="text-slate-500 block mb-1">ุงุณุชูุงู ุงูุนูู ุงูุญุงูู</span><span class="text-white font-bold" x-text="managerData.job_assumption_date || '---'"></span></div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-green-500/30"><span class="text-slate-500 block mb-1">ุชุงุฑูุฎ ุงูุชุฌุฏูุฏ</span><span class="text-green-400 font-black" x-text="managerData.renewal_date || '---'"></span></div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-red-500/30"><span class="text-slate-500 block mb-1">ุชุงุฑูุฎ ุงูุชูุงุนุฏ</span><span class="text-red-400 font-black" x-text="managerData.retirement_date || '---'"></span></div>
                        </div>
                    </div>
                </div>

                <div x-show="isEditingForm" x-cloak>
                    <h2 class="text-2xl font-black text-[#F5C678] text-center mb-6">ุชุญุฏูุซ ุงูุจูุงูุงุช</h2>
                    <div class="mb-6 relative">
                        <div class="avatar-upload-wrapper">
                            <img :src="formData.avatar_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'">
                            <div class="avatar-upload-overlay">ุชุบููุฑ ุงูุตูุฑุฉ</div>
                            <input type="file" accept="image/*" @change="uploadAvatar" class="absolute inset-0 opacity-0 cursor-pointer z-10" :disabled="loadingAvatar">
                        </div>
                        <p x-show="!formData.avatar_url" class="text-center text-xs text-red-500 font-bold mt-2">โ๏ธ ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ ุฅูุฒุงููุฉ</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2"><label>ุงูุงุณู ุฑุจุงุนูุงู</label><input type="text" x-model="formData.full_name" class="input w-full input-light"></div>
                        <div><label>ุงูุฑูู ุงููููู (14 ุฑูู)</label><input type="tel" x-model="formData.nid" maxlength="14" @input="calculateDates" class="input w-full input-light font-mono"></div>
                        <div><label>ุงูููุจุงูู</label><input type="tel" x-model="formData.mobile" readonly class="input w-full input-readonly font-mono"></div>
                        <div><label>ุชุงุฑูุฎ ุงูุชุนููู</label><input type="date" x-model="formData.hiring_date" class="input w-full input-light"></div>
                        <div><label>ุชุงุฑูุฎ ุงุณุชูุงู ุงูุนูู</label><input type="date" x-model="formData.job_assumption_date" @change="calculateDates" class="input w-full input-light border-[#D68C29]"></div>
                        <div class="bg-red-500/5 p-2 rounded-xl"><label class="!text-red-400">ุชุงุฑูุฎ ุงูุชูุงุนุฏ</label><input type="date" x-model="formData.retirement_date" readonly class="input w-full input-readonly text-red-500"></div>
                        <div class="bg-green-500/5 p-2 rounded-xl"><label class="!text-green-400">ุชุงุฑูุฎ ุงูุชุฌุฏูุฏ</label><input type="date" x-model="formData.renewal_date" readonly class="input w-full input-readonly text-green-600"></div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button @click="validateAndShowOath" class="btn flex-1 btn-gold">ุญูุธ ูุฅููุงุก ๐พ</button>
                        <button @click="isEditingForm = false" class="btn bg-slate-700 text-white border-none">ุฅูุบุงุก</button>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="currentView === 'agent_profile'" x-transition x-cloak>
            <button @click="currentView = 'menu'; isEditingForm = false" class="home-btn">ุงูุฑุฆูุณูุฉ</button>
            <div class="glass-panel p-6 border-t-4 border-t-blue-500">
                <div x-show="!isEditingForm">
                    <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
                        <h2 class="text-2xl font-black text-white">ุณุฌู ุงููููู</h2>
                        <button x-show="!currentUser.full_name || currentUser.full_name === 'ุจุงูุชุธุงุฑ ุงุณุชููุงู ุงูุจูุงูุงุช'" @click="isEditingForm = true" class="btn btn-sm btn-success text-white border-none shadow-md animate-pulse">ุชุณุฌูู ุจูุงูุงุชู ๐</button>
                        <button x-show="currentUser.full_name && currentUser.full_name !== 'ุจุงูุชุธุงุฑ ุงุณุชููุงู ุงูุจูุงูุงุช'" @click="isEditingForm = true" class="btn btn-sm bg-blue-500/20 text-blue-400 border border-blue-500/50 hover:bg-blue-500 hover:text-white">ุชุนุฏูู โ๏ธ</button>
                    </div>
                    <div class="bg-black/20 p-5 rounded-2xl border border-white/5 space-y-4">
                        <div class="flex items-center gap-4 pb-4 border-b border-white/10">
                            <img :src="currentUser.avatar_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" class="w-20 h-20 rounded-full border-4 border-blue-500 object-cover bg-white shadow-xl">
                            <div>
                                <h3 class="text-xl font-black text-blue-400" x-text="currentUser.full_name || 'ุจุงูุชุธุงุฑ ุงูุชุณุฌูู'"></h3>
                                <span class="badge bg-blue-600 text-white border-none mt-2 px-3 py-2" x-text="currentUser.agent_assignment || 'ูู ูุญุฏุฏ ุงูุชูููู'"></span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm md:text-base">
                            <div class="bg-[#141A32] p-3 rounded-xl border border-white/5"><span class="text-slate-500 block mb-1">ุงูููุจุงูู</span><span class="text-white font-mono" x-text="currentUser.mobile || '---'"></span></div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-white/5"><span class="text-slate-500 block mb-1">ุงูุฑูู ุงููููู</span><span class="text-yellow-400 font-mono tracking-widest font-bold" x-text="currentUser.nid || '---'"></span></div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-white/5"><span class="text-slate-500 block mb-1">ุชุงุฑูุฎ ุงูุชุนููู</span><span class="text-white font-bold" x-text="currentUser.hiring_date || '---'"></span></div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-white/5"><span class="text-slate-500 block mb-1">ุงุณุชูุงู ุงูุนูู ุงูุญุงูู</span><span class="text-white font-bold" x-text="currentUser.job_assumption_date || '---'"></span></div>
                        </div>
                    </div>
                </div>

                <div x-show="isEditingForm" x-cloak>
                    <h2 class="text-2xl font-black text-blue-400 text-center mb-6">ุชุณุฌูู ุจูุงูุงุช ุงููููู</h2>
                    <div class="mb-6 relative">
                        <div class="avatar-upload-wrapper agent-avatar-border">
                            <img :src="formData.avatar_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'">
                            <div class="avatar-upload-overlay">ุชุบููุฑ ุงูุตูุฑุฉ</div>
                            <input type="file" accept="image/*" @change="uploadAvatar" class="absolute inset-0 opacity-0 cursor-pointer z-10" :disabled="loadingAvatar">
                        </div>
                        <p x-show="!formData.avatar_url" class="text-center text-xs text-red-500 font-bold mt-2">โ๏ธ ุฅุฑูุงู ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ ุฅูุฒุงูู</p>
                    </div>

                    <div class="bg-black/20 p-6 rounded-3xl border border-white/10 space-y-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="md:col-span-2">
                                <label class="!text-blue-400">ุงูุชูููู (ุทุจูุนุฉ ุงูุนูู)</label>
                                <select x-model="formData.agent_assignment" class="select w-full input-light h-14 rounded-xl text-lg font-bold">
                                    <option value="" disabled selected>ุงุฎุชุฑ ุทุจูุนุฉ ุงูุนูู...</option>
                                    <option value="ุดุฆูู ุทูุงุจ">ุดุฆูู ุทูุงุจ</option>
                                    <option value="ุดุฆูู ุนุงูููู">ุดุฆูู ุนุงูููู</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label>ุงูุงุณู ุฑุจุงุนูุงู (ุฅุฌุจุงุฑู)</label>
                                <input type="text" x-model="formData.full_name" placeholder="ุงูุงุณู ุงูุฃูู ูุงูุซุงูู ูุงูุซุงูุซ ูุงูููุจ" class="input w-full input-light h-14 rounded-xl text-lg">
                            </div>
                            <div class="md:col-span-2"><label>ุงูุฑูู ุงููููู (14 ุฑูู)</label><input type="tel" x-model="formData.nid" maxlength="14" @input="calculateDates" class="input w-full input-light h-14 rounded-xl text-center font-mono text-lg tracking-widest"></div>
                            <div><label>ุชุงุฑูุฎ ุงูุชุนููู</label><input type="date" x-model="formData.hiring_date" class="input w-full input-light h-14 rounded-xl text-center"></div>
                            <div><label>ุงุณุชูุงู ุงูุนูู ุงูุญุงูู</label><input type="date" x-model="formData.job_assumption_date" @change="calculateDates" class="input w-full input-light h-14 rounded-xl text-center"></div>
                        </div>
                        <div class="flex gap-3 mt-8 pt-6 border-t border-white/10">
                            <button @click="validateAndShowOath" class="btn flex-1 bg-blue-600 hover:bg-blue-700 text-white h-14 rounded-xl text-xl font-black border-none">ุญูุธ ุจูุงูุงุชู ๐พ</button>
                            <button @click="isEditingForm = false" class="btn bg-slate-700 text-white h-14 rounded-xl border-none px-8">ุฅูุบุงุก</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="currentView === 'messages'" x-transition x-cloak>
            <button @click="currentView = 'menu'" class="home-btn">ุงูุฑุฆูุณูุฉ</button>
            <div class="glass-panel p-6 border-t-4 border-t-purple-500">
                <h2 class="text-2xl font-black text-white text-center mb-6">โ๏ธ ุตูุฏูู ุงูุชุนูููุงุช</h2>
                <div class="space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                    <template x-for="msg in schoolMessages" :key="msg.id">
                        <div class="bg-black/30 p-5 rounded-2xl border border-purple-500/30">
                            <div class="flex justify-between items-center border-b border-white/10 pb-2 mb-2">
                                <span :class="`badge text-white font-bold border-none ${msg.school_id ? 'bg-blue-600' : 'bg-purple-600'}`" x-text="msg.school_id ? 'ุฑุณุงูุฉ ุฎุงุตุฉ' : 'ุชุนููู'"></span>
                                <span class="text-xs text-slate-400" x-text="new Date(msg.created_at).toLocaleDateString('ar-EG')"></span>
                            </div>
                            <p class="text-white text-sm whitespace-pre-wrap" x-text="msg.message"></p>
                            <template x-if="msg.file_url"><a :href="msg.file_url" target="_blank" class="btn btn-sm bg-purple-600/20 text-purple-300 mt-3 border-none">ุนุฑุถ ุงููุฑูู ๐</a></template>
                        </div>
                    </template>
                    <div x-show="schoolMessages.length === 0" class="text-center text-slate-500">ูุง ุชูุฌุฏ ุฑุณุงุฆู ุฌุฏูุฏุฉ</div>
                </div>
            </div>
        </div>

        <div x-show="currentView === 'requests'" x-transition x-cloak>
            <button @click="currentView = 'menu'" class="home-btn">ุงูุฑุฆูุณูุฉ</button>
            <div class="glass-panel p-6 border-t-4 border-t-[#F5C678]">
                <h2 class="text-2xl font-black text-white text-center mb-6">๐ค ุฑูุน ุงูุฅูุฑุงุฑุงุช ูุงูุชูุณูู</h2>
                <div class="space-y-4">
                    <textarea x-model="requestForm.statement" placeholder="ููุถูุน ุงูุทูุจ..." class="textarea w-full input-light h-32"></textarea>
                    <input type="file" @change="e => requestForm.file = e.target.files[0]" class="file-input file-input-bordered w-full bg-white text-black">
                    <button @click="submitRequest" class="btn w-full btn-gold h-14 text-xl">ุฅุฑุณุงู ๐</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function madrasaApp() {
            const client = supabase.createClient('https://zjvnppqygcpccbtgebbq.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpqdm5wcHF5Z2NwY2NidGdlYmJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MTE1MjgsImV4cCI6MjA4Njk4NzUyOH0.LnUKMQkfh4YWMvUxO11wAw5ZY_k52PGAeVMVOky_ts0');
            return {
                currentView: 'menu', isEditingForm: false, showOathModal: false, loading: false, sendingReport: false, loadingAvatar: false, loadingAgents: false,
                currentUser: null, managerData: {}, school: { manager_status: '', teachers_count: 0, admins_count: 0, workers_count: 0, students_count: 0, female_students_count: 0, classrooms_count: 0 }, 
                schoolAgents: [], formData: {}, newAgentMobile: '', requestForm: { statement: '', file: null },
                schoolMessages: [], archiveList: [], newArchive: { title: '', file: null },
                
                selectedAgent: null,
                showAgentDetailsModal: false,

                alertModal: { show: false, type: 'success', title: '', message: '' },
                showAlert(title, message, type = 'success') { this.alertModal = { show: true, type, title, message }; },
                closeAlert() { this.alertModal.show = false; },

                async initApp() {
                    const uid = new URLSearchParams(window.location.search).get('uid');
                    if (!uid) return window.location.href = 'login.html';
                    
                    let { data: user } = await client.from('users').select('*, schools(*)').eq('mobile', uid).single();
                    if (!user) { localStorage.removeItem('login_mobile'); return window.location.href = 'login.html'; }

                    this.currentUser = user; this.school = user.schools || {};
                    ['teachers_count', 'admins_count', 'workers_count', 'students_count', 'female_students_count', 'classrooms_count'].forEach(k => {
                        if(this.school[k] === undefined || this.school[k] === null) this.school[k] = 0;
                    });
                    
                    let { data: mgr } = await client.from('users').select('*').eq('school_id', this.school.id).eq('role', 'manager').maybeSingle();
                    this.managerData = mgr || {};
                    
                    this.fetchAgents();
                    this.fetchSchoolMessages();
                },

                viewAgentDetails(agent) {
                    this.selectedAgent = agent;
                    this.showAgentDetailsModal = true;
                },

                async fetchSchoolMessages() {
                    if (!this.school?.id) return;
                    const { data } = await client.from('messages').select('*').or(`school_id.is.null,school_id.eq.${this.school.id}`).order('created_at', { ascending: false });
                    this.schoolMessages = data || [];
                },

                async fetchArchive() {
                    if (!this.school?.id) return;
                    const { data } = await client.from('school_archive').select('*').eq('school_id', this.school.id).order('created_at', { ascending: false });
                    this.archiveList = data || [];
                },

                async saveToArchive() {
                    if(!this.newArchive.title) return this.showAlert('ุฎุทุฃ', 'ูุฑุฌู ูุชุงุจุฉ ุนููุงู ุงููุณุชูุฏ', 'error');
                    this.loading = true;
                    let fileUrl = null;
                    try {
                        if (this.newArchive.file) {
                            const file = this.newArchive.file;
                            const fileName = `archive_${this.school.id}_${Date.now()}.${file.name.split('.').pop()}`;
                            const { error: uploadError } = await client.storage.from('requests_files').upload(fileName, file);
                            if(uploadError) throw uploadError;
                            const { data } = client.storage.from('requests_files').getPublicUrl(fileName);
                            fileUrl = data.publicUrl;
                        }
                        const { error } = await client.from('school_archive').insert([{ school_id: this.school.id, title: this.newArchive.title, file_url: fileUrl }]);
                        if(error) throw error;
                        this.showAlert('ุชู ุงูุญูุธ', 'ุชู ุฅุถุงูุฉ ุงููุณุชูุฏ ููุฃุฑุดูู ุงูุณุฑู ุจูุฌุงุญ', 'success');
                        this.newArchive.title = ''; this.newArchive.file = null; 
                        document.querySelector('.file-input').value = '';
                        this.fetchArchive();
                    } catch (err) { this.showAlert('ุฎุทุฃ', 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฑูุน ุงููุณุชูุฏ', 'error'); }
                    this.loading = false;
                },

                async deleteArchive(id) {
                    if(!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุณุชูุฏ ูู ุงูุฃุฑุดููุ')) return;
                    await client.from('school_archive').delete().eq('id', id);
                    this.fetchArchive();
                },

                // ุฌูุจ ุงููููุงุก ุจุทุฑููุฉ ูุจุงุดุฑุฉ ูุตุงุฑูุฉ ุจูุงุกู ุนูู ูุนุฑู ูุฏุฑุณุฉ ุงููุฏูุฑ ููุณู
                async fetchAgents() { 
                    this.loadingAgents = true;
                    const s_id = this.currentUser.school_id;
                    if (!s_id) { 
                        this.loadingAgents = false; 
                        return; 
                    }
                    
                    const { data, error } = await client.from('users').select('*').eq('school_id', s_id).eq('role', 'agent').order('id'); 
                    if (error) console.error(error);
                    
                    this.schoolAgents = data ? [...data] : []; 
                    this.loadingAgents = false;
                },
                
                openManagerView() { this.currentView = 'manager'; this.isEditingForm = false; this.formData = { ...this.managerData }; if(!this.formData.mobile) this.formData.mobile = this.currentUser.mobile; },
                openAgentProfile() { this.currentView = 'agent_profile'; this.formData = { ...this.currentUser }; if (!this.currentUser.full_name || this.currentUser.full_name === 'ุจุงูุชุธุงุฑ ุงุณุชููุงู ุงูุจูุงูุงุช') { this.formData.full_name = ''; this.isEditingForm = true; } else { this.isEditingForm = false; } },
                
                calculateDates() { 
                    let nid = this.formData.nid; 
                    if (nid && nid.length === 14) { 
                        let y = parseInt((nid[0] === '2' ? '19' : '20') + nid.substring(1, 3)), m = nid.substring(3, 5), d = nid.substring(5, 7); 
                        this.formData.dob = `${y}-${m}-${d}`; this.formData.retirement_date = `${y + 60}-${m}-${d}`; 
                    } 
                    if (this.formData.job_assumption_date) { 
                        let date = new Date(this.formData.job_assumption_date); date.setFullYear(date.getFullYear() + 2); 
                        this.formData.renewal_date = date.toISOString().split('T')[0]; 
                    } 
                },

                async uploadAvatar(e) {
                    const file = e.target.files[0]; if(!file) return;
                    this.loadingAvatar = true;
                    try {
                        const fileName = `${Date.now()}_avatar_${this.currentUser.mobile}.${file.name.split('.').pop()}`;
                        const { error: uploadError } = await client.storage.from('avatars').upload(fileName, file);
                        if(uploadError) throw uploadError;
                        const { data } = client.storage.from('avatars').getPublicUrl(fileName);
                        await client.from('users').update({ avatar_url: data.publicUrl }).eq('mobile', this.currentUser.mobile);
                        this.currentUser.avatar_url = data.publicUrl;
                        if(this.currentUser.role === 'manager') this.managerData.avatar_url = data.publicUrl; else this.fetchAgents();
                        this.formData.avatar_url = data.publicUrl; 
                        this.showAlert('ูุฌุงุญ โ', 'ุชู ุชุญุฏูุซ ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ ุจูุฌุงุญ', 'success');
                    } catch(err) { this.showAlert('ุฎุทุฃ ุจุงูุฑูุน', 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฑูุน ุงูุตูุฑุฉ', 'error'); }
                    finally { this.loadingAvatar = false; }
                },

                validateAndShowOath() {
                    if (!this.formData.avatar_url) return this.showAlert('ุตูุฑุฉ ููููุฏุฉ', 'ุฅุฑูุงู ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ ุฅูุฒุงูู.', 'error');
                    const nameParts = (this.formData.full_name || '').trim().split(/\s+/);
                    if (nameParts.length < 4) return this.showAlert('ุจูุงูุงุช ุบูุฑ ุตุญูุญุฉ', 'ูุฌุจ ุฅุฏุฎุงู ุงูุงุณู ุฑุจุงุนูุงู.', 'error');
                    const nid = (this.formData.nid || '').trim();
                    if (nid.length !== 14 || isNaN(nid)) return this.showAlert('ุจูุงูุงุช ุบูุฑ ุตุญูุญุฉ', 'ุงูุฑูู ุงููููู 14 ุฑูู.', 'error');
                    this.showOathModal = true;
                },

                async confirmAndSave() {
                    this.showOathModal = false; this.loading = true;
                    const payload = { full_name: this.formData.full_name, nid: this.formData.nid, dob: this.formData.dob || null, hiring_date: this.formData.hiring_date || null, job_assumption_date: this.formData.job_assumption_date || null, retirement_date: this.formData.retirement_date || null, renewal_date: this.formData.renewal_date || null, agent_assignment: this.formData.agent_assignment || null };
                    const { error } = await client.from('users').update(payload).eq('mobile', this.currentUser.mobile);
                    if (error) { this.loading = false; return this.showAlert('ุฎุทุฃ', 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ.', 'error'); }
                    this.currentUser = { ...this.currentUser, ...payload };
                    if(this.currentUser.role === 'manager') { this.managerData = { ...this.currentUser }; } else { await this.fetchAgents(); }
                    this.loading = false; this.isEditingForm = false; 
                    this.showAlert('ุชู ุงูุชุณุฌูู ุจูุฌุงุญ โ', 'ุชู ุญูุธ ุจูุงูุงุชู ุจูุฌุงุญ.', 'success');
                },

                // ุงูุชุญุฏูุซ ุงูุณุฑูุน ูุงููุจุงุดุฑ ุจุฏูู ุงูุชุธุงุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช
                async addNewAgent() { 
                    if (!this.newAgentMobile || this.newAgentMobile.length !== 11) {
                        return this.showAlert('ุฎุทุฃ', 'ุฃุฏุฎู ุฑูู ููุจุงูู 11 ุฑููุงู ุตุญูุญุงู.', 'error');
                    }
                    
                    this.loadingAgents = true;
                    const s_id = this.currentUser.school_id;

                    const newObj = { 
                        mobile: this.newAgentMobile, 
                        school_id: s_id, 
                        role: 'agent', 
                        pin: '0000', 
                        full_name: 'ุจุงูุชุธุงุฑ ุงุณุชููุงู ุงูุจูุงูุงุช' 
                    };

                    const { error } = await client.from('users').insert([newObj]); 
                    if (error) {
                        this.loadingAgents = false;
                        return this.showAlert('ุฎุทุฃ', 'ูุฐุง ุงูุฑูู ูุณุฌู ูุณุจูุงู ุฃู ุญุฏุซุช ูุดููุฉ ุจุงูุงุชุตุงู.', 'error');
                    }
                    
                    // ุญูู ุงููููู ูุจุงุดุฑุฉ ูู ุงูุดุงุดุฉ ุนุดุงู ูุธูุฑ ููุฑุงู!
                    this.schoolAgents.push(newObj);
                    this.newAgentMobile = ''; 
                    this.loadingAgents = false;
                    this.showAlert('ูุฌุงุญ โ', 'ุชู ุฅุถุงูุฉ ุงููููู ุจูุฌุงุญ.', 'success'); 
                },
                
                async removeAgent(mobile) { 
                    if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูููููุ')) return; 
                    
                    // ุญุฐู ูุจุงุดุฑ ูู ุงูุดุงุดุฉ
                    this.schoolAgents = this.schoolAgents.filter(a => a.mobile !== mobile);
                    
                    await client.from('users').delete().eq('mobile', mobile); 
                },
                
                async updateAgentStatus(mobile, status) { 
                    if (!status) return; 
                    await client.from('users').update({ job_status: status }).eq('mobile', mobile); 
                },

                async submitRequest() {
                    if (!this.requestForm.statement) return this.showAlert('ุชูุจูู', 'ูุฑุฌู ูุชุงุจุฉ ุงูุทูุจ', 'error');
                    this.loading = true; let fileUrl = null;
                    try {
                        if (this.requestForm.file) {
                            const file = this.requestForm.file;
                            const fileName = `${Date.now()}_doc_${this.school.id}.${file.name.split('.').pop()}`;
                            await client.storage.from('requests_files').upload(fileName, file);
                            fileUrl = client.storage.from('requests_files').getPublicUrl(fileName).data.publicUrl;
                        }
                        await client.from('coordination_requests').insert([{ school_id: this.school.id, statement: this.requestForm.statement, file_url: fileUrl }]);
                        this.showAlert('ุชู ุงูุฅุฑุณุงู', 'ุชู ุฅุฑุณุงู ุงูุทูุจ ููุชูุณูู! ๐', 'success');
                        this.requestForm.statement = ''; this.requestForm.file = null; setTimeout(() => { this.currentView = 'menu'; }, 2000);
                    } catch (err) { this.showAlert('ุฎุทุฃ', 'ุญุฏุซ ุฎุทุฃ ุจุงูุฑูุน', 'error'); }
                    finally { this.loading = false; }
                },

                async exportStatsToAdmin() {
                    if (!this.school.manager_status) return this.showAlert('ุฎุทุฃ', 'ูุฌุจ ุชุญุฏูุฏ ูููู ูุฏูุฑ ุงููุฏุฑุณุฉ ุฃููุงู.', 'error');
                    this.sendingReport = true;
                    try {
                        await client.from('schools').update({ 
                            teachers_count: this.school.teachers_count || 0,
                            admins_count: this.school.admins_count || 0,
                            workers_count: this.school.workers_count || 0,
                            classrooms_count: this.school.classrooms_count || 0, 
                            students_count: this.school.students_count || 0,
                            female_students_count: this.school.female_students_count || 0,
                            manager_status: this.school.manager_status
                        }).eq('id', this.school.id);

                        let agentsText = '';
                        if (this.schoolAgents.length > 0) {
                            this.schoolAgents.forEach((a, i) => {
                                agentsText += `๐จโ๐ซ ุงููููู ${i + 1} (${a.agent_assignment || 'ุจุฏูู'}): [${a.job_status || 'ูู ูุญุฏุฏ'}] - ${a.full_name || 'ุบูุฑ ูุณุฌู'}\n`;
                            });
                        } else { agentsText = '๐จโ๐ซ ูุง ููุฌุฏ ูููุงุก.\n'; }

                        const reportText = `๐ ุฅุญุตุงุก ุงููุฏุฑุณุฉ ุงูุดุงูู
-----------------------------------------
๐ซ ูุฏุฑุณุฉ: ${this.school.name}
-----------------------------------------
๐จโ๐ผ ุงููุฏูุฑ: [${this.school.manager_status}] - ${this.managerData.full_name || 'ุบูุฑ ูุณุฌู'}
${agentsText}
-----------------------------------------
๐ฅ ููุฉ ุงูุนูู ุจุงููุฏุฑุณุฉ:
๐จโ๐ซ ุนุฏุฏ ุงููุนูููู: ${this.school.teachers_count || 0}
๐จโ๐ป ุนุฏุฏ ุงูุฅุฏุงุฑููู: ${this.school.admins_count || 0}
๐งน ุงูุนูุงู ูุงูุฎุฏูุงุช: ${this.school.workers_count || 0}
-----------------------------------------
๐ ุฃุนุฏุงุฏ ุงูุทูุงุจ ูุงููุตูู:
๐ฆ ุงูุจููู: ${this.school.students_count || 0} | ๐ง ุงูุจูุงุช: ${this.school.female_students_count || 0}
๐ช ุฅุฌูุงูู ุงููุตูู: ${this.school.classrooms_count || 0} ูุตู`;

                        await client.from('coordination_requests').insert([{ school_id: this.school.id, statement: reportText }]);
                        this.showAlert('ุชู ุงูุชุตุฏูุฑ ุจูุฌุงุญ โ', 'ุชู ุฅุฑุณุงู ุงูุฅุญุตุงุก ุฅูู ุงูุชูุณูู.', 'success');
                    } catch (err) { this.showAlert('ุฎุทุฃ', 'ุญุฏุซ ุฎุทุฃ ุจุงูุชุตุฏูุฑ.', 'error'); }
                    this.sendingReport = false;
                },

                logout() { localStorage.clear(); window.location.href = 'login.html'; }
            }
        }
    </script>
</body>
</html>
