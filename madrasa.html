<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฅุฏุงุฑุฉ ุงููุฏุฑุณุฉ - ุงูุชูุณูู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #141A32; min-height: 100vh; color: #E8EDEB; padding-bottom: 20px; overflow-x: hidden; transition: background-color 0.4s, color 0.4s; }
        .glass-panel { background: rgba(20, 26, 50, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(214, 140, 41, 0.3); border-radius: 1.5rem; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); }
        .input-light { background-color: #ffffff !important; color: #1e293b !important; border: 2px solid #cbd5e1; font-weight: 800; transition: all 0.3s ease;}
        .input-light:focus { border-color: #D68C29; outline: none; box-shadow: 0 0 0 3px rgba(214, 140, 41, 0.3); }
        .input-readonly { background-color: #f1f5f9 !important; color: #64748b !important; border: 1px solid #e2e8f0; cursor: not-allowed; font-weight: 900 !important; }
        label { font-size: 0.85rem; font-weight: bold; color: #D68C29; margin-bottom: 0.4rem; display: block; }
        .btn-gold { background: linear-gradient(135deg, #D68C29 0%, #B4731D 100%); color: white; border: none; box-shadow: 0 5px 15px rgba(214, 140, 41, 0.3); transition: all 0.3s;}
        .btn-gold:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(214, 140, 41, 0.5); }
        
        .main-card { background: linear-gradient(145deg, rgba(30,41,59,0.9), rgba(15,23,42,0.9)); border: 2px solid rgba(255,255,255,0.05); border-radius: 20px; padding: 20px 15px; text-align: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.3);}
        .main-card:hover { transform: translateY(-8px); border-color: #D68C29; box-shadow: 0 15px 30px rgba(214, 140, 41, 0.2); background: linear-gradient(145deg, rgba(30,41,59,1), rgba(20,26,50,1));}
        .icon-wrapper { width: 55px; height: 55px; border-radius: 50%; background: rgba(214, 140, 41, 0.1); display: flex; align-items: center; justify-content: center; color: #F5C678; transition: all 0.3s; }
        .main-card:hover .icon-wrapper { background: #D68C29; color: #141A32; transform: scale(1.1); }
        
        .home-btn { display: inline-flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.1); color: white; padding: 8px 20px; border-radius: 50px; font-weight: bold; border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s; margin-bottom: 20px; text-decoration: none;}
        .home-btn:hover { background: #D68C29; border-color: #D68C29; color: #141A32; box-shadow: 0 5px 15px rgba(214, 140, 41, 0.4); transform: translateX(-5px);}
        
        .avatar-upload-wrapper { position: relative; width: 100px; height: 100px; margin: 0 auto; border-radius: 50%; overflow: hidden; border: 3px solid #D68C29; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3);}
        .avatar-upload-wrapper img { width: 100%; height: 100%; object-fit: cover; background: #fff;}
        .avatar-upload-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; font-size: 12px; font-weight: bold; padding: 6px 0; text-align: center; opacity: 0; transition: 0.3s;}
        .avatar-upload-wrapper:hover .avatar-upload-overlay { opacity: 1; }

        /* ๐ ุชูุณููุงุช ุงููุถุน ุงูููุงุฑู ๐ */
        body.light-theme { background-color: #f1f5f9; color: #0f172a; }
        body.light-theme .glass-panel, body.light-theme .bg-\[\#141A32\], body.light-theme .bg-black\/30, body.light-theme .bg-black\/20 { background: #ffffff !important; border-color: #cbd5e1 !important; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        body.light-theme .main-card { background: #ffffff; border-color: #cbd5e1; }
        body.light-theme .main-card:hover { background: #f8fafc; border-color: #D68C29; }
        body.light-theme h2, body.light-theme h3, body.light-theme h4, body.light-theme .text-white { color: #0f172a !important; }
        body.light-theme .text-slate-400, body.light-theme .text-slate-500 { color: #475569 !important; font-weight: bold; }
        body.light-theme .text-\[\#F5C678\] { color: #b45309 !important; }
        body.light-theme .bg-\[\#0B0F1E\] { background: #f8fafc !important; border-color: #cbd5e1 !important; }
        body.light-theme .home-btn { background: #e2e8f0; color: #0f172a; border-color: #cbd5e1; }
        
        .theme-toggle-btn { position: fixed; top: 85px; left: 20px; z-index: 50; background: white; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: all 0.3s ease; border: 2px solid #D68C29; color: #F5C678; font-size: 1.3rem;}
        body.light-theme .theme-toggle-btn { background: #141A32; border-color: #cbd5e1; color: #b45309; }

        /* ๐ ุชูุณููุงุช ุงูุทุจุงุนุฉ ๐ */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; direction: rtl; background: white; color: black; padding: 20px; font-family: 'Times New Roman', serif;}
            .print-hidden { display: none !important; }
            .print-border { border: 1px solid #000; padding: 8px; border-collapse: collapse; }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #D68C29; border-radius: 10px; }
        [x-cloak] { display: none !important; }
    </style>
</head>

<body x-data="madrasaApp()" x-init="initApp()">

    <button @click="toggleTheme()" class="theme-toggle-btn print-hidden" title="ุชุบููุฑ ุงูุฅุถุงุกุฉ">
        <span x-show="!isLightMode">โ๏ธ</span><span x-show="isLightMode" x-cloak>๐</span>
    </button>

    <div x-show="alertModal.show" class="fixed inset-0 z-[99999] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 print-hidden" x-cloak x-transition><div class="bg-white w-full max-w-sm p-8 rounded-3xl shadow-2xl text-center transform transition-all" :class="alertModal.type === 'success' ? 'border-t-8 border-green-500' : 'border-t-8 border-red-500'"><div class="text-6xl mb-4" x-text="alertModal.type === 'success' ? 'โ' : 'โ๏ธ'"></div><h3 class="text-2xl font-black text-slate-800 mb-2" x-text="alertModal.title"></h3><p class="text-slate-600 font-bold mb-6 text-sm" x-text="alertModal.message"></p><button @click="closeAlert()" :class="`btn w-full text-white font-black text-lg h-12 rounded-xl border-none ${alertModal.type === 'success' ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'}`">ุญุณูุงู</button></div></div>
    
    <div x-show="showOathModal" class="fixed inset-0 z-[100000] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 print-hidden" x-cloak x-transition><div class="bg-[#141A32] w-full max-w-md p-8 rounded-3xl shadow-[0_0_40px_rgba(214,140,41,0.3)] border border-[#D68C29]/50 text-center relative overflow-hidden"><div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-red-500 via-yellow-500 to-red-500"></div><div class="w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-red-500/50 text-4xl">โ๏ธ</div><h3 class="text-2xl font-black text-white mb-4">ุฅูุฑุงุฑ ูุงูููู</h3><div class="bg-black/40 p-5 rounded-xl border border-white/10 mb-6"><p class="text-slate-300 font-bold leading-loose text-sm md:text-base">"ุฃุชุนูุฏ ุฃูุง <span class="text-[#F5C678] font-black mx-1" x-text="formData.full_name"></span> ุจุฃู ุฌููุน ุงูุจูุงูุงุช ุงูููุฏุฎูุฉ ูุงููุญููุธุฉ ูู ูุฐุง ุงูุณุฌู ุตุญูุญุฉ ูุฏูููุฉุ ูุนูู ูุณุฆูููุชู ุงูุดุฎุตูุฉ."</p></div><div class="flex gap-3"><button @click="confirmAndSave()" class="btn flex-1 bg-green-600 hover:bg-green-700 text-white font-black text-lg h-14 rounded-xl border-none shadow-lg">ุฃูุงูู ูุฃุชุนูุฏ โ</button><button @click="showOathModal = false" class="btn bg-slate-700 hover:bg-slate-600 text-white font-black text-lg h-14 rounded-xl border-none">ุชุฑุงุฌุน โ</button></div></div></div>

    <div class="w-full p-4 flex justify-between items-center bg-[#141A32]/90 backdrop-blur sticky top-0 z-40 border-b border-[#D68C29]/30 shadow-lg print-hidden">
        <div><p class="text-xs text-slate-400">ููุญุฉ ุชุญูู ูุฏุฑุณุฉ:</p><h1 class="text-xl md:text-2xl font-black text-[#D68C29]" x-text="school.name || 'ุฌุงุฑู ุงูุชุญููู...'"></h1></div>
        <div class="text-left">
            <span class="badge bg-slate-700 text-white border-none text-xs mb-1 px-3 py-2" x-text="currentUser?.role === 'manager' ? '๐ ูุฏูุฑ ุงููุฏุฑุณุฉ' : '๐จโ๐ซ ูููู'"></span>
            <button @click="logout" class="block text-red-400 font-bold text-sm hover:text-red-300 w-full text-left mt-1">ุฎุฑูุฌ ๐ช</button>
        </div>
    </div>

    <div class="p-4 max-w-5xl mx-auto min-h-[80vh] mt-4 relative print-hidden">

        <div x-show="currentView === 'menu'" x-transition.opacity x-cloak>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">
                <div x-show="currentUser?.role === 'manager'" @click="openManagerView()" class="main-card relative">
                    <span x-show="!managerData.full_name" class="absolute top-3 right-3 flex h-4 w-4"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-4 w-4 bg-red-500"></span></span>
                    <div class="icon-wrapper"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg></div>
                    <div><h2 class="text-lg font-black text-white">ุจูุงูุงุช ุงููุฏูุฑ</h2><p class="text-[10px] text-slate-400 mt-1">ุงูุณุฌู ุงููุธููู</p></div>
                </div>
                
                <div x-show="currentUser?.role === 'manager'" @click="currentView = 'agents'" class="main-card">
                    <div class="icon-wrapper"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>
                    <div><h2 class="text-lg font-black text-white">ุฅุฏุงุฑุฉ ุงููููุงุก</h2><p class="text-[10px] text-slate-400 mt-1">ุฅุถุงูุฉ ูุญุฐู ุจุฑูู ุงูููุจุงูู</p></div>
                </div>

                <div x-show="currentUser?.role === 'manager'" @click="currentView = 'agent_records'" class="main-card bg-gradient-to-br from-cyan-900/50 to-[#141A32]">
                    <div class="icon-wrapper !bg-cyan-500/20 !text-cyan-400"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div>
                    <div><h2 class="text-lg font-black text-cyan-400">ูููุงุช ุงููููุงุก</h2><p class="text-[10px] text-slate-400 mt-1">ุนุฑุถ ุงูุณุฌู ุงููุธููู</p></div>
                </div>
                
                <div x-show="currentUser?.role === 'agent'" @click="openAgentProfile()" class="main-card relative">
                    <span x-show="!currentUser?.full_name || currentUser?.full_name === 'ุจุงูุชุธุงุฑ ุงุณุชููุงู ุงูุจูุงูุงุช'" class="absolute top-3 right-3 flex h-4 w-4"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-4 w-4 bg-red-500"></span></span>
                    <div class="icon-wrapper"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div>
                    <div><h2 class="text-lg font-black text-white">ุจูุงูุงุชู ุงููุธูููุฉ</h2><p class="text-[10px] text-slate-400 mt-1">ุชุญุฏูุซ ุณุฌูู</p></div>
                </div>

                <div @click="currentView = 'statistics'; setTimeout(()=>renderCharts(), 200)" class="main-card">
                    <div class="icon-wrapper"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg></div>
                    <div><h2 class="text-lg font-black text-white">ุงูุฅุญุตุงุก ุงูุดุงูู</h2><p class="text-[10px] text-slate-400 mt-1">ุฑุณูู ุจูุงููุฉ ูุฃุนุฏุงุฏ</p></div>
                </div>

                <div @click="currentView = 'messages'" class="main-card relative">
                    <span x-show="schoolMessages.length > 0" class="absolute top-3 right-3 bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full animate-pulse shadow-lg border border-white" x-text="schoolMessages.length"></span>
                    <div class="icon-wrapper"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg></div>
                    <div><h2 class="text-lg font-black text-white">ุงูุชุนูููุงุช ุงููุงุฑุฏุฉ</h2><p class="text-[10px] text-slate-400 mt-1">ุตูุฏูู ุงููุฑุงุณูุงุช</p></div>
                </div>

                <div @click="currentView = 'requests'" class="main-card md:col-span-2">
                    <div class="icon-wrapper"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg></div>
                    <div><h2 class="text-lg font-black text-white">ุฅุฑุณุงู ุทูุจ ููุชูุณูู</h2><p class="text-[10px] text-slate-400 mt-1">ุฑูุน ุงููููุงุช ูุงูุฅูุฑุงุฑุงุช ุงููุทููุจุฉ</p></div>
                </div>
            </div>
        </div>

        <div x-show="currentView === 'agent_records'" x-transition x-cloak>
            <div class="flex justify-between items-center mb-4">
                <button @click="currentView = 'menu'" class="home-btn mb-0">ุงูุฑุฆูุณูุฉ</button>
                <button @click="fetchAgents()" class="btn btn-sm btn-ghost text-cyan-400 border border-cyan-500/30">
                    <span x-show="!loadingAgents">ุชุญุฏูุซ ๐</span>
                    <span x-show="loadingAgents" class="loading loading-spinner loading-xs"></span>
                </button>
            </div>
            
            <div class="glass-panel p-6 border-t-4 border-t-cyan-500">
                <h2 class="text-2xl font-black text-white text-center mb-8">ุงูุณุฌูุงุช ุงููุธูููุฉ ูููููุงุก</h2>
                
                <div x-show="schoolAgents.length === 0 && !loadingAgents" class="text-center py-10 bg-black/20 rounded-2xl border border-white/5">
                    <span class="text-6xl block mb-4 grayscale">๐ฅ</span>
                    <p class="text-white font-black text-xl mb-2">ูุง ููุฌุฏ ูููุงุก ูุณุฌููู!</p>
                    <p class="text-slate-400 mb-6 text-sm">ูุฅุธูุงุฑ ุจูุงูุงุช ุงููููู ููุงุ ูุฌุจ ุฅุถุงูุชู ุฃููุงู ูู ุดุงุดุฉ (ุฅุฏุงุฑุฉ ุงููููุงุก).</p>
                    <button @click="currentView = 'agents'" class="btn btn-outline btn-info rounded-xl">ุงูุฐูุงุจ ูุฅุถุงูุฉ ูููู โ</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" x-show="schoolAgents.length > 0">
                    <template x-for="(agent, i) in schoolAgents" :key="i + 'rec'">
                        <div class="bg-black/30 p-5 rounded-2xl border border-cyan-500/20 hover:border-cyan-500/50 transition-all">
                            <div class="flex items-center gap-4 mb-4 pb-4 border-b border-white/5">
                                <img :src="agent.avatar_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" class="w-16 h-16 rounded-full border-2 border-cyan-500 object-cover bg-white">
                                <div>
                                    <h3 class="font-black text-white text-lg leading-tight" x-text="agent.full_name || 'ุจุงูุชุธุงุฑ ุงุณุชููุงู ุงูุจูุงูุงุช'"></h3>
                                    <span class="text-xs font-bold bg-cyan-900/40 text-cyan-400 px-2 py-1 rounded mt-2 inline-block border border-cyan-500/30" x-text="agent.agent_assignment || 'ุจุฏูู ุชูููู'"></span>
                                </div>
                            </div>
                            <div class="text-sm space-y-2 text-slate-300 bg-[#0B0F1E] p-4 rounded-xl border border-white/5">
                                <div class="flex justify-between border-b border-white/5 pb-1"><span class="font-bold text-slate-500">ุงููููู:</span><span class="font-mono text-yellow-300 tracking-widest font-bold" x-text="agent.nid || '---'"></span></div>
                                <div class="flex justify-between border-b border-white/5 pb-1"><span class="font-bold text-slate-500">ุชุงุฑูุฎ ุงูุชุนููู:</span><span class="text-white" x-text="agent.hiring_date || '---'"></span></div>
                                <div class="flex justify-between border-b border-white/5 pb-1"><span class="font-bold text-slate-500">ุชุงุฑูุฎ ุงูุชุฌุฏูุฏ:</span><span class="text-green-400 font-bold" x-text="agent.renewal_date || '---'"></span></div>
                                <div class="flex justify-between pt-1"><span class="font-bold text-slate-500">ุงููููู ุงููุงูู:</span><span class="text-blue-300 font-bold" x-text="agent.job_status || '---'"></span></div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <div x-show="currentView === 'manager'" x-transition x-cloak>
            <div class="flex justify-between items-center mb-4">
                <button @click="currentView = 'menu'; isEditingForm = false" class="home-btn mb-0">ุงูุฑุฆูุณูุฉ</button>
                <button @click="printPage()" class="btn btn-sm btn-ghost border border-[#D68C29]/50 text-[#D68C29]">๐จ๏ธ ุทุจุงุนุฉ ุงูุณุฌู ุงูุฑุณูู</button>
            </div>
            <div class="glass-panel p-6 border-t-4 border-t-[#D68C29]">
                <div x-show="!isEditingForm">
                    <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
                        <h2 class="text-2xl font-black text-white">ุงูุณุฌู ุงููุธููู ูููุฏูุฑ</h2>
                        <button x-show="!managerData.full_name" @click="isEditingForm = true" class="btn btn-sm btn-success text-white border-none animate-pulse">ุชุณุฌูู ุจูุงูุงุชู</button>
                        <button x-show="managerData.full_name" @click="isEditingForm = true" class="btn btn-sm bg-[#D68C29]/20 text-[#D68C29] hover:bg-[#D68C29] hover:text-white border-none">ุชุนุฏูู โ๏ธ</button>
                    </div>
                    
                    <div class="bg-black/20 p-5 rounded-2xl border border-white/5 space-y-4">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6 bg-[#0B0F1E] p-3 rounded-xl border border-white/5">
                            <div class="text-center p-2"><span class="text-[10px] text-slate-500 block">ุงููููุงุก</span><span class="font-black text-blue-400 text-lg" x-text="schoolAgents.length"></span></div>
                            <div class="text-center p-2 border-r border-white/10"><span class="text-[10px] text-slate-500 block">ุงูุทูุจุงุช</span><span class="font-black text-green-400 text-lg" x-text="requests.length"></span></div>
                            <div class="text-center p-2 border-r border-white/10"><span class="text-[10px] text-slate-500 block">ุงูุฑุณุงุฆู</span><span class="font-black text-purple-400 text-lg" x-text="schoolMessages.length"></span></div>
                            <div class="text-center p-2 border-r border-white/10"><span class="text-[10px] text-slate-500 block">ุงููููู</span><span class="font-black text-yellow-400 text-sm" x-text="school.manager_status || 'ุบูุฑ ูุญุฏุฏ'"></span></div>
                        </div>

                        <div class="flex items-center gap-4 pb-4 border-b border-white/10">
                            <img :src="managerData.avatar_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" class="w-20 h-20 rounded-full border-4 border-[#D68C29] object-cover bg-white shadow-lg">
                            <div>
                                <h3 class="text-xl font-black text-[#F5C678]" x-text="managerData.full_name || 'ูู ูุชู ุงูุชุณุฌูู ุจุนุฏ'"></h3>
                                <p class="text-slate-400 font-mono mt-1 text-sm" x-text="managerData.mobile || '---'"></p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm md:text-base">
                            <div class="bg-[#141A32] p-3 rounded-xl border border-white/5"><span class="text-slate-500 block mb-1 font-bold">ุงูุฑูู ุงููููู</span><span class="text-yellow-400 font-mono font-bold tracking-widest" x-text="managerData.nid || '---'"></span></div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-white/5"><span class="text-slate-500 block mb-1 font-bold">ุชุงุฑูุฎ ุงููููุงุฏ</span><span class="text-white font-bold" x-text="managerData.dob || '---'"></span></div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-white/5"><span class="text-slate-500 block mb-1 font-bold">ุชุงุฑูุฎ ุงูุชุนููู</span><span class="text-white font-bold" x-text="managerData.hiring_date || '---'"></span></div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-white/5"><span class="text-slate-500 block mb-1 font-bold">ุชุงุฑูุฎ ุงุณุชูุงู ุงูุนูู</span><span class="text-white font-bold" x-text="managerData.job_assumption_date || '---'"></span></div>
                            <div class="bg-green-900/20 p-3 rounded-xl border border-green-500/30"><span class="text-green-500 block mb-1 font-bold">ุชุงุฑูุฎ ุงูุชุฌุฏูุฏ (+2 ุณูุฉ)</span><span class="text-green-400 font-black" x-text="managerData.renewal_date || '---'"></span></div>
                            <div class="bg-red-900/20 p-3 rounded-xl border border-red-500/30"><span class="text-red-500 block mb-1 font-bold">ุชุงุฑูุฎ ุงูุชูุงุนุฏ (ุณู 60)</span><span class="text-red-400 font-black" x-text="managerData.retirement_date || '---'"></span></div>
                        </div>
                    </div>
                </div>

                <div x-show="isEditingForm" x-cloak>
                    <h2 class="text-2xl font-black text-[#F5C678] text-center mb-6">ุชุญุฏูุซ ุงูุจูุงูุงุช</h2>
                    <div class="mb-6 relative">
                        <div class="avatar-upload-wrapper">
                            <img :src="formData.avatar_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'">
                            <div class="avatar-upload-overlay">ุชุบููุฑ ุงูุตูุฑุฉ</div>
                            <input type="file" accept="image/*" @change="uploadAvatar" class="absolute inset-0 opacity-0 cursor-pointer z-10" :disabled="loadingAvatar">
                        </div>
                        <p x-show="!formData.avatar_url" class="text-center text-xs text-red-500 font-bold mt-2">โ๏ธ ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ ุฅูุฒุงููุฉ</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2"><label>ุงูุงุณู ุฑุจุงุนูุงู (ููู ุฌุฏุงู)</label><input type="text" x-model="formData.full_name" class="input w-full input-light" placeholder="ุงูุงุณู ุงูุฃูู ูุงูุซุงูู ูุงูุซุงูุซ ูุงูููุจ"></div>
                        <div><label>ุงูุฑูู ุงููููู (14 ุฑูู)</label><input type="tel" x-model="formData.nid" maxlength="14" @input="calculateDates" class="input w-full input-light font-mono tracking-widest text-center"></div>
                        <div><label>ุงูููุจุงูู</label><input type="tel" x-model="formData.mobile" readonly class="input w-full input-readonly font-mono text-center"></div>
                        <div><label>ุชุงุฑูุฎ ุงูุชุนููู ุงูุฃูู</label><input type="date" x-model="formData.hiring_date" class="input w-full input-light text-center"></div>
                        <div><label>ุงุณุชูุงู ุงูุนูู ุงูููุงุฏู ุงูุญุงูู</label><input type="date" x-model="formData.job_assumption_date" @change="calculateDates" class="input w-full input-light border-[#D68C29] text-center"></div>
                        <div><label>ุงููููู ุงููุธููู ููููุงุฏุฉ</label>
                            <select x-model="school.manager_status" class="select w-full input-light font-bold">
                                <option value="" disabled selected>ุงุฎุชุฑ ุงููููู...</option><option value="ูุนูู ุจูุฑุงุฑ">ูุนูู ุจูุฑุงุฑ</option><option value="ูููู">ูููู</option>
                            </select>
                        </div>
                        <div class="bg-green-500/5 p-2 rounded-xl"><label class="!text-green-600">ุชุงุฑูุฎ ุงูุชุฌุฏูุฏ (ุชููุงุฆู)</label><input type="date" x-model="formData.renewal_date" readonly class="input w-full input-readonly text-green-600 text-center font-black"></div>
                    </div>
                    <div class="flex gap-3 mt-6 pt-4 border-t border-white/10">
                        <button @click="validateAndShowOath" class="btn flex-1 btn-gold text-lg h-14 rounded-xl">ุญูุธ ูุฅููุงุก ๐พ</button>
                        <button @click="isEditingForm = false" class="btn bg-slate-700 text-white border-none h-14 rounded-xl px-8">ุฅูุบุงุก</button>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="currentView === 'agent_profile'" x-transition x-cloak>
            <div class="flex justify-between items-center mb-4">
                <button @click="currentView = 'menu'; isEditingForm = false" class="home-btn mb-0">ุงูุฑุฆูุณูุฉ</button>
                <button @click="printPage()" class="btn btn-sm btn-ghost border border-blue-500/50 text-blue-400">๐จ๏ธ ุทุจุงุนุฉ ุงูุณุฌู ุงูุฑุณูู</button>
            </div>
            <div class="glass-panel p-6 border-t-4 border-t-blue-500">
                <div x-show="!isEditingForm">
                    <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
                        <h2 class="text-2xl font-black text-white">ุงูุณุฌู ุงููุธููู ูููููู</h2>
                        <button x-show="!currentUser?.full_name || currentUser?.full_name === 'ุจุงูุชุธุงุฑ ุงุณุชููุงู ุงูุจูุงูุงุช'" @click="isEditingForm = true" class="btn btn-sm btn-success text-white border-none shadow-md animate-pulse">ุชุณุฌูู ุจูุงูุงุชู ๐</button>
                        <button x-show="currentUser?.full_name && currentUser?.full_name !== 'ุจุงูุชุธุงุฑ ุงุณุชููุงู ุงูุจูุงูุงุช'" @click="isEditingForm = true" class="btn btn-sm bg-blue-500/20 text-blue-400 border border-blue-500/50 hover:bg-blue-500 hover:text-white">ุชุนุฏูู โ๏ธ</button>
                    </div>
                    <div class="bg-black/20 p-5 rounded-2xl border border-white/5 space-y-4">
                        <div class="flex items-center gap-4 pb-4 border-b border-white/10">
                            <img :src="currentUser?.avatar_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" class="w-20 h-20 rounded-full border-4 border-blue-500 object-cover bg-white shadow-xl">
                            <div>
                                <h3 class="text-xl font-black text-blue-400" x-text="currentUser?.full_name || 'ุจุงูุชุธุงุฑ ุงูุชุณุฌูู'"></h3>
                                <div class="flex gap-2 mt-2">
                                    <span class="badge bg-blue-600 text-white border-none px-3 py-2 font-bold" x-text="currentUser?.agent_assignment || 'ูู ูุญุฏุฏ ุงูุชูููู'"></span>
                                    <span class="badge bg-green-600 text-white border-none px-3 py-2 font-bold" x-text="currentUser?.job_status || 'ุงููููู ุงููุงูู ุบูุฑ ูุญุฏุฏ'"></span>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm md:text-base">
                            <div class="bg-[#141A32] p-3 rounded-xl border border-white/5"><span class="text-slate-500 block mb-1 font-bold">ุงูุงุณู ุฑุจุงุนูุงู</span><span class="text-white font-black" x-text="currentUser?.full_name || '---'"></span></div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-white/5"><span class="text-slate-500 block mb-1 font-bold">ุงูููุจุงูู</span><span class="text-white font-mono" x-text="currentUser?.mobile || '---'"></span></div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-white/5"><span class="text-slate-500 block mb-1 font-bold">ุงูุฑูู ุงููููู</span><span class="text-yellow-400 font-mono tracking-widest font-bold" x-text="currentUser?.nid || '---'"></span></div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-white/5"><span class="text-slate-500 block mb-1 font-bold">ุชุงุฑูุฎ ุงููููุงุฏ</span><span class="text-white font-bold" x-text="currentUser?.dob || '---'"></span></div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-white/5"><span class="text-slate-500 block mb-1 font-bold">ุชุงุฑูุฎ ุงูุชุนููู</span><span class="text-white font-bold" x-text="currentUser?.hiring_date || '---'"></span></div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-white/5"><span class="text-slate-500 block mb-1 font-bold">ุงุณุชูุงู ุงูุนูู ุงูุญุงูู</span><span class="text-white font-bold" x-text="currentUser?.job_assumption_date || '---'"></span></div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-green-500/30"><span class="text-green-500 block mb-1 font-bold">ุชุงุฑูุฎ ุงูุชุฌุฏูุฏ (+2 ุณูุฉ)</span><span class="text-green-400 font-black" x-text="currentUser?.renewal_date || '---'"></span></div>
                            <div class="bg-[#141A32] p-3 rounded-xl border border-red-500/30"><span class="text-red-500 block mb-1 font-bold">ุชุงุฑูุฎ ุงูุชูุงุนุฏ (ุณู 60)</span><span class="text-red-400 font-black" x-text="currentUser?.retirement_date || '---'"></span></div>
                        </div>
                    </div>
                </div>

                <div x-show="isEditingForm" x-cloak>
                    <h2 class="text-2xl font-black text-blue-400 text-center mb-6">ุชุณุฌูู ุจูุงูุงุช ุงููููู</h2>
                    <div class="mb-6 relative">
                        <div class="avatar-upload-wrapper !border-blue-500">
                            <img :src="formData.avatar_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'">
                            <div class="avatar-upload-overlay">ุชุบููุฑ ุงูุตูุฑุฉ</div>
                            <input type="file" accept="image/*" @change="uploadAvatar" class="absolute inset-0 opacity-0 cursor-pointer z-10" :disabled="loadingAvatar">
                        </div>
                        <p x-show="!formData.avatar_url" class="text-center text-xs text-red-500 font-bold mt-2">โ๏ธ ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ ุฅูุฒุงููุฉ</p>
                    </div>

                    <div class="bg-black/20 p-6 rounded-3xl border border-white/10 space-y-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="md:col-span-2">
                                <label class="!text-blue-400">ุงูุชูููู (ุทุจูุนุฉ ุงูุนูู)</label>
                                <select x-model="formData.agent_assignment" class="select w-full input-light h-14 rounded-xl text-lg font-bold">
                                    <option value="" disabled selected>ุงุฎุชุฑ ุทุจูุนุฉ ุงูุนูู...</option><option value="ุดุฆูู ุทูุงุจ">ุดุฆูู ุทูุงุจ</option><option value="ุดุฆูู ุนุงูููู">ุดุฆูู ุนุงูููู</option>
                                </select>
                            </div>
                            <div class="md:col-span-2"><label>ุงูุงุณู ุฑุจุงุนูุงู (ุฅุฌุจุงุฑู)</label><input type="text" x-model="formData.full_name" placeholder="ุงูุงุณู ุงูุฃูู ูุงูุซุงูู ูุงูุซุงูุซ ูุงูููุจ" class="input w-full input-light h-14 rounded-xl text-lg"></div>
                            <div><label>ุงูุฑูู ุงููููู (14 ุฑูู)</label><input type="tel" x-model="formData.nid" maxlength="14" @input="calculateDates" class="input w-full input-light h-14 rounded-xl text-center font-mono text-lg tracking-widest"></div>
                            <div><label>ุงูููุจุงูู</label><input type="tel" x-model="formData.mobile" readonly class="input w-full input-readonly h-14 rounded-xl text-center font-mono text-lg"></div>
                            <div><label>ุชุงุฑูุฎ ุงูุชุนููู ุงูุฃูู</label><input type="date" x-model="formData.hiring_date" class="input w-full input-light h-14 rounded-xl text-center"></div>
                            <div><label>ุงุณุชูุงู ุงูุนูู ุงูููุงุฏู ุงูุญุงูู</label><input type="date" x-model="formData.job_assumption_date" @change="calculateDates" class="input w-full input-light border-blue-500 h-14 rounded-xl text-center"></div>
                            <div><label>ุงููููู ุงููุงูู</label>
                                <select x-model="formData.job_status" class="select w-full input-light h-14 rounded-xl font-bold">
                                    <option value="" disabled selected>ุงุฎุชุฑ ุงููููู...</option><option value="ูุนูู ุจูุฑุงุฑ">ูุนูู ุจูุฑุงุฑ</option><option value="ูููู">ูููู</option>
                                </select>
                            </div>
                            <div class="bg-green-500/5 p-2 rounded-xl"><label class="!text-green-600">ุชุงุฑูุฎ ุงูุชุฌุฏูุฏ (ุชููุงุฆู)</label><input type="date" x-model="formData.renewal_date" readonly class="input w-full input-readonly text-green-600 h-10 text-center font-black"></div>
                        </div>
                        <div class="flex gap-3 mt-8 pt-6 border-t border-white/10">
                            <button @click="validateAndShowOath" class="btn flex-1 bg-blue-600 hover:bg-blue-700 text-white h-14 rounded-xl text-xl font-black border-none">ุญูุธ ุจูุงูุงุชู ๐พ</button>
                            <button @click="isEditingForm = false" class="btn bg-slate-700 text-white h-14 rounded-xl border-none px-8">ุฅูุบุงุก</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="currentView === 'statistics'" x-transition x-cloak>
            <div class="flex justify-between items-center mb-4">
                <button @click="currentView = 'menu'" class="home-btn mb-0"><svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg> ุงูุฑุฆูุณูุฉ</button>
                <button @click="exportStatsToAdmin" x-show="currentUser?.role === 'manager'" class="btn btn-sm btn-success text-white border-none shadow-md">ุฅุฑุณุงู ููุชูุณูู ๐ค</button>
            </div>
            
            <div class="glass-panel p-6 border-t-4 border-t-teal-500">
                <h2 class="text-2xl font-black text-white text-center mb-6">๐ ููุญุฉ ุงูุฅุญุตุงุฆูุงุช ุงูุดุงููุฉ</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="space-y-4 bg-black/20 p-5 rounded-2xl border border-white/10">
                        <h3 class="text-teal-400 font-bold border-b border-white/10 pb-2 mb-4">ุชุญุฏูุซ ุงูุฃุฑูุงู</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-indigo-400">ุงููุนูููู</label><input type="number" x-model="school.teachers_count" @input="renderCharts()" class="input w-full input-light text-center font-black" :disabled="currentUser?.role !== 'manager'"></div>
                            <div><label class="text-teal-400">ุงูุฅุฏุงุฑููู</label><input type="number" x-model="school.admins_count" @input="renderCharts()" class="input w-full input-light text-center font-black" :disabled="currentUser?.role !== 'manager'"></div>
                            <div><label class="text-amber-400">ุงูุนูุงู</label><input type="number" x-model="school.workers_count" @input="renderCharts()" class="input w-full input-light text-center font-black" :disabled="currentUser?.role !== 'manager'"></div>
                            <div><label class="text-purple-400">ุงููุตูู</label><input type="number" x-model="school.classrooms_count" class="input w-full input-light text-center font-black" :disabled="currentUser?.role !== 'manager'"></div>
                            <div><label class="text-blue-400">ุงูุจููู</label><input type="number" x-model="school.students_count" @input="renderCharts()" class="input w-full input-light text-center font-black" :disabled="currentUser?.role !== 'manager'"></div>
                            <div><label class="text-pink-400">ุงูุจูุงุช</label><input type="number" x-model="school.female_students_count" @input="renderCharts()" class="input w-full input-light text-center font-black" :disabled="currentUser?.role !== 'manager'"></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white/5 p-4 rounded-2xl border border-white/10 flex flex-col items-center justify-center h-[250px]">
                            <h4 class="text-sm font-bold text-slate-300 mb-2">ุชูุฒูุน ููุฉ ุงูุนูู</h4>
                            <div class="w-full max-w-[200px] h-full relative"><canvas id="staffChart"></canvas></div>
                        </div>
                        <div class="bg-white/5 p-4 rounded-2xl border border-white/10 flex flex-col items-center justify-center h-[250px]">
                            <h4 class="text-sm font-bold text-slate-300 mb-2">ุชูุฒูุน ุงูุทูุงุจ</h4>
                            <div class="w-full max-w-[200px] h-full relative"><canvas id="studentChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="currentView === 'agents'" x-transition x-cloak>
            <div class="flex justify-between items-center mb-4"><button @click="currentView = 'menu'" class="home-btn mb-0">ุงูุฑุฆูุณูุฉ</button><button @click="fetchAgents()" class="btn btn-sm btn-ghost text-blue-400 border border-blue-500/30"><span x-show="!loadingAgents">๐ ุชุญุฏูุซ</span><span x-show="loadingAgents" class="loading loading-spinner loading-xs"></span></button></div>
            <div class="glass-panel p-6 border-t-4 border-t-blue-500">
                <h2 class="text-2xl font-black text-white text-center mb-6">โ๏ธ ุฅุฏุงุฑุฉ ุงููููุงุก</h2>
                <div class="bg-black/30 p-5 rounded-2xl border border-white/10 mb-8">
                    <label class="mb-2 block text-[#D68C29] text-sm font-bold">ุฅุถุงูุฉ ูููู ุจุฑูู ุงูููุจุงูู</label>
                    <div class="flex gap-3"><input type="tel" x-model="newAgentMobile" maxlength="11" class="input w-full input-light rounded-xl font-mono"><button @click="addNewAgent()" class="btn btn-success text-white">ุฅุถุงูุฉ</button></div>
                </div>
                <div class="space-y-4">
                    <template x-for="(agent, i) in schoolAgents" :key="i + 'mgmt'">
                        <div class="bg-gradient-to-l from-slate-800 to-[#141A32] p-4 rounded-2xl border border-white/10 flex justify-between items-center">
                            <div class="flex items-center gap-4"><img :src="agent.avatar_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" class="w-10 h-10 rounded-full object-cover bg-white"><div><h3 class="font-bold text-white" x-text="agent.full_name || 'ุจุงูุชุธุงุฑ ุงูุชุณุฌูู'"></h3><p class="text-blue-300 font-mono text-xs" x-text="agent.mobile"></p></div></div>
                            <button @click="removeAgent(agent.mobile)" class="btn btn-sm btn-error text-white">ุฅุฒุงูุฉ ๐๏ธ</button>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <div x-show="currentView === 'messages'" x-transition x-cloak>
            <button @click="currentView = 'menu'" class="home-btn">ุงูุฑุฆูุณูุฉ</button>
            <div class="glass-panel p-6 border-t-4 border-t-purple-500"><h2 class="text-2xl font-black text-white text-center mb-6">โ๏ธ ุตูุฏูู ุงูุชุนูููุงุช ูุงููุดุฑุงุช</h2><div class="space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2"><template x-for="msg in schoolMessages" :key="msg.id"><div class="bg-black/30 p-5 rounded-2xl border border-purple-500/30"><div class="flex justify-between items-center border-b border-white/10 pb-2 mb-3"><span :class="`badge text-white font-bold border-none ${msg.school_id ? 'bg-blue-600' : 'bg-purple-600'}`" x-text="msg.school_id ? 'ุฑุณุงูุฉ ุฎุงุตุฉ ุจูุฏุฑุณุชู' : 'ุชุนููู ุฅุฏุงุฑู'"></span><span class="text-xs text-slate-400 font-bold" x-text="new Date(msg.created_at).toLocaleDateString('ar-EG')"></span></div><p class="text-white text-sm whitespace-pre-wrap leading-loose" x-text="msg.message"></p><template x-if="msg.file_url"><div class="mt-4 pt-3 border-t border-white/5"><a :href="msg.file_url" target="_blank" class="btn btn-sm bg-purple-600/20 text-purple-300 border-none rounded-lg">ุนุฑุถ ุงููุฑูู ุงูุฑุณูู ๐</a></div></template></div></template><div x-show="schoolMessages.length === 0" class="text-center text-slate-500 py-10 font-bold">ูุง ุชูุฌุฏ ุฑุณุงุฆู ูุงุฑุฏุฉ ุญุงููุงู.</div></div></div>
        </div>

        <div x-show="currentView === 'requests'" x-transition x-cloak>
            <button @click="currentView = 'menu'" class="home-btn">ุงูุฑุฆูุณูุฉ</button>
            <div class="glass-panel p-6 border-t-4 border-t-[#F5C678]"><h2 class="text-2xl font-black text-white text-center mb-6">๐ค ุฑูุน ุงูุฅูุฑุงุฑุงุช ูุงูุทูุจุงุช</h2><div class="space-y-4 bg-black/20 p-6 rounded-3xl border border-white/10"><label class="text-[#D68C29] block font-bold">ููุถูุน ุงูุทูุจ / ุงูุฅูุฑุงุฑ</label><textarea x-model="requestForm.statement" class="textarea w-full input-light h-32 rounded-xl text-lg" placeholder="ุงูุชุจ ุชูุงุตูู ุทูุจู ููุง..."></textarea><label class="text-[#D68C29] block font-bold mt-4">ุฅุฑูุงู ุงููุณุชูุฏ (ุตูุฑุฉ ุฃู PDF)</label><input type="file" @change="e => requestForm.file = e.target.files[0]" class="file-input file-input-bordered w-full bg-white text-black h-14 rounded-xl"><button @click="submitRequest" class="btn w-full btn-gold h-14 text-xl font-black mt-6 rounded-xl shadow-lg">ุฅุฑุณุงู ููุชูุณูู ๐</button></div></div>
        </div>

    </div>

    <div id="printArea" class="hidden print:block absolute top-0 left-0 w-full bg-white text-black p-8" style="direction: rtl;">
        <div style="display: flex; justify-content: space-between; border-bottom: 3px solid black; padding-bottom: 10px; margin-bottom: 20px;">
            <div style="text-align: right; line-height: 1.5; font-weight: bold; font-size: 16px;">
                <p>ูุญุงูุธุฉ ุณููุงุฌ</p>
                <p>ูุฏูุฑูุฉ ุงูุชุฑุจูุฉ ูุงูุชุนููู</p>
                <p>ุฅุฏุงุฑุฉ ุณููุงุฌ ุงูุชุนููููุฉ</p>
            </div>
            <div style="text-align: center;">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a6/Coat_of_arms_of_Egypt_%28Official%29.svg/120px-Coat_of_arms_of_Egypt_%28Official%29.svg.png" style="width: 80px;">
            </div>
            <div style="text-align: left; line-height: 1.5; font-weight: bold; font-size: 16px;">
                <p>ุชูุณูู ุงูุชุนููู ุงูุฅุนุฏุงุฏู ูุงูุซุงููู</p>
                <p>ูุฏุฑุณุฉ: <span x-text="school.name"></span></p>
                <p>ุงูุชุงุฑูุฎ: <span x-text="new Date().toLocaleDateString('ar-EG')"></span></p>
            </div>
        </div>

        <h2 style="text-align: center; font-size: 24px; font-weight: bold; text-decoration: underline; margin-bottom: 30px;">ุตุญููุฉ ุฃุญูุงู ูุชุดููู ุฅุฏุงุฑุฉ ุงููุฏุฑุณุฉ</h2>

        <div style="margin-bottom: 30px;">
            <h3 style="background: #eee; padding: 8px; border: 1px solid black; font-weight: bold;">ุฃููุงู: ุจูุงูุงุช ุงูุณูุฏ/ุฉ ูุฏูุฑ ุงููุฏุฑุณุฉ</h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <tr><th class="print-border" style="width: 20%; background: #f9f9f9; text-align: right;">ุงูุงุณู ุฑุจุงุนู</th><td class="print-border" colspan="3" font-weight="bold" x-text="managerData.full_name || 'ุบูุฑ ูุณุฌู'"></td></tr>
                <tr><th class="print-border" style="background: #f9f9f9; text-align: right;">ุงูุฑูู ุงููููู</th><td class="print-border" style="font-family: monospace;" x-text="managerData.nid || '---'"></td><th class="print-border" style="background: #f9f9f9; text-align: right;">ุชุงุฑูุฎ ุงููููุงุฏ</th><td class="print-border" x-text="managerData.dob || '---'"></td></tr>
                <tr><th class="print-border" style="background: #f9f9f9; text-align: right;">ุชุงุฑูุฎ ุงูุชุนููู</th><td class="print-border" x-text="managerData.hiring_date || '---'"></td><th class="print-border" style="background: #f9f9f9; text-align: right;">ุชุงุฑูุฎ ุงุณุชูุงู ุงูุนูู</th><td class="print-border" x-text="managerData.job_assumption_date || '---'"></td></tr>
                <tr><th class="print-border" style="background: #f9f9f9; text-align: right;">ุงููููู ุงููุธููู</th><td class="print-border" font-weight="bold" x-text="school.manager_status || '---'"></td><th class="print-border" style="background: #f9f9f9; text-align: right;">ุชุงุฑูุฎ ุงูุชุฌุฏูุฏ</th><td class="print-border" x-text="managerData.renewal_date || '---'"></td></tr>
            </table>
        </div>

        <div>
            <h3 style="background: #eee; padding: 8px; border: 1px solid black; font-weight: bold;">ุซุงููุงู: ุทุงูู ุงููููุงุก ุจุงููุฏุฑุณุฉ</h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; text-align: center;">
                <thead>
                    <tr style="background: #f9f9f9;">
                        <th class="print-border">ู</th><th class="print-border">ุงูุงุณู ุฑุจุงุนู</th><th class="print-border">ุงูุฑูู ุงููููู</th><th class="print-border">ุงูุชูููู</th><th class="print-border">ุงููููู ุงููุงูู</th><th class="print-border">ุงุณุชูุงู ุงูุนูู</th><th class="print-border">ุงูุชุฌุฏูุฏ</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="(agent, idx) in schoolAgents" :key="idx + 'p'">
                        <tr>
                            <td class="print-border" x-text="idx + 1"></td><td class="print-border" style="text-align: right; font-weight: bold;" x-text="agent.full_name || 'ุบูุฑ ูุณุฌู'"></td>
                            <td class="print-border" style="font-family: monospace;" x-text="agent.nid || '---'"></td><td class="print-border" x-text="agent.agent_assignment || '---'"></td>
                            <td class="print-border" x-text="agent.job_status || '---'"></td><td class="print-border" x-text="agent.job_assumption_date || '---'"></td><td class="print-border" x-text="agent.renewal_date || '---'"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <div style="margin-top: 60px; display: flex; justify-content: space-between; text-align: center; font-weight: bold; font-size: 16px;">
            <div><p>ุชูููุน ูุฏูุฑ ุงููุฏุฑุณุฉ</p><p style="margin-top: 40px;">.......................................</p></div>
            <div><p>ุฎุงุชู ุดุนุงุฑ ุงูุฌูููุฑูุฉ (ุงููุฏุฑุณุฉ)</p><div style="width: 80px; height: 80px; border-radius: 50%; border: 2px dashed #999; margin: 15px auto;"></div></div>
            <div><p>ูุนุชูุฏ ุุุ ูุฏูุฑ ุนุงู ุงูุฅุฏุงุฑุฉ</p><p style="margin-top: 40px;">.......................................</p></div>
        </div>
    </div>

    <script>
        function madrasaApp() {
            const client = supabase.createClient('https://zjvnppqygcpccbtgebbq.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpqdm5wcHF5Z2NwY2NidGdlYmJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MTE1MjgsImV4cCI6MjA4Njk4NzUyOH0.LnUKMQkfh4YWMvUxO11wAw5ZY_k52PGAeVMVOky_ts0');
            return {
                currentView: 'menu', isEditingForm: false, showOathModal: false, loading: false, sendingReport: false, loadingAvatar: false, loadingAgents: false,
                currentUser: null, managerData: {}, school: { manager_status: '', teachers_count: 0, admins_count: 0, workers_count: 0, students_count: 0, female_students_count: 0, classrooms_count: 0 }, 
                schoolAgents: [], formData: {}, newAgentMobile: '', requestForm: { statement: '', file: null },
                schoolMessages: [], requests: [],
                isLightMode: localStorage.getItem('theme') === 'light',
                
                staffChart: null, studentChart: null,

                alertModal: { show: false, type: 'success', title: '', message: '' }, showAlert(title, message, type = 'success') { this.alertModal = { show: true, type, title, message }; }, closeAlert() { this.alertModal.show = false; },

                async initApp() {
                    if (this.isLightMode) document.body.classList.add('light-theme');
                    const uid = new URLSearchParams(window.location.search).get('uid');
                    if (!uid) return window.location.href = 'login.html';
                    
                    let { data: user } = await client.from('users').select('*, schools(*)').eq('mobile', uid).single();
                    if (!user) { localStorage.removeItem('login_mobile'); return window.location.href = 'login.html'; }

                    this.currentUser = user; this.school = user.schools || {};
                    ['teachers_count', 'admins_count', 'workers_count', 'students_count', 'female_students_count', 'classrooms_count'].forEach(k => { if(this.school[k] === undefined || this.school[k] === null) this.school[k] = 0; });
                    
                    let { data: mgr } = await client.from('users').select('*').eq('school_id', this.school.id).eq('role', 'manager').maybeSingle();
                    this.managerData = mgr || {};
                    
                    this.fetchAgents(); this.fetchSchoolMessages(); this.fetchRequests();
                },

                toggleTheme() {
                    this.isLightMode = !this.isLightMode;
                    localStorage.setItem('theme', this.isLightMode ? 'light' : 'dark');
                    if (this.isLightMode) { document.body.classList.add('light-theme'); } else { document.body.classList.remove('light-theme'); }
                    if (this.currentView === 'statistics') setTimeout(() => this.renderCharts(), 100);
                },

                printPage() { window.print(); },

                renderCharts() {
                    const isDark = !this.isLightMode;
                    const textColor = isDark ? '#E8EDEB' : '#0f172a';
                    
                    if(this.staffChart) this.staffChart.destroy();
                    if(this.studentChart) this.studentChart.destroy();

                    const ctxStaff = document.getElementById('staffChart');
                    if(ctxStaff) {
                        this.staffChart = new Chart(ctxStaff, {
                            type: 'doughnut',
                            data: { labels: ['ูุนูููู', 'ุฅุฏุงุฑููู', 'ุนูุงู'], datasets: [{ data: [this.school.teachers_count||0, this.school.admins_count||0, this.school.workers_count||0], backgroundColor: ['#818cf8', '#2dd4bf', '#fbbf24'], borderWidth: isDark? 0: 2 }] },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor, font: { family: 'Cairo' } } } }, cutout: '60%' }
                        });
                    }

                    const ctxStudent = document.getElementById('studentChart');
                    if(ctxStudent) {
                        this.studentChart = new Chart(ctxStudent, {
                            type: 'pie',
                            data: { labels: ['ุจููู', 'ุจูุงุช'], datasets: [{ data: [this.school.students_count||0, this.school.female_students_count||0], backgroundColor: ['#60a5fa', '#f472b6'], borderWidth: isDark? 0: 2 }] },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor, font: { family: 'Cairo' } } } } }
                        });
                    }
                },

                async fetchSchoolMessages() { const { data } = await client.from('messages').select('*').or(`school_id.is.null,school_id.eq.${this.school.id}`).order('created_at', { ascending: false }); this.schoolMessages = data || []; },
                
                async fetchRequests() { const { data } = await client.from('coordination_requests').select('*').eq('school_id', this.school.id); this.requests = data || []; },

                // ๐ ุฏุงูุฉ ุฌูุจ ุงููููุงุก ุงููุนุฏูุฉ ูุญู ุงููุดููุฉ ๐
                async fetchAgents() { 
                    this.loadingAgents = true; 
                    const s_id = this.currentUser?.school_id; 
                    if (!s_id) { this.loadingAgents = false; return; }
                    
                    try {
                        const { data, error } = await client.from('users').select('*').eq('school_id', s_id).eq('role', 'agent');
                        if (error) throw error;
                        this.schoolAgents = data || []; 
                    } catch (err) {
                        console.error(err);
                        this.schoolAgents = [];
                    } finally {
                        this.loadingAgents = false; 
                    }
                },
                
                openManagerView() { this.currentView = 'manager'; this.isEditingForm = false; this.formData = { ...this.managerData }; if(!this.formData.mobile) this.formData.mobile = this.currentUser.mobile; },
                openAgentProfile() { this.currentView = 'agent_profile'; this.formData = { ...this.currentUser }; if (!this.currentUser.full_name || this.currentUser.full_name === 'ุจุงูุชุธุงุฑ ุงุณุชููุงู ุงูุจูุงูุงุช') { this.formData.full_name = ''; this.isEditingForm = true; } else { this.isEditingForm = false; } },
                
                calculateDates() { 
                    let nid = this.formData.nid; 
                    if (nid && nid.length === 14) { 
                        let y = parseInt((nid[0] === '2' ? '19' : '20') + nid.substring(1, 3)), m = nid.substring(3, 5), d = nid.substring(5, 7); 
                        this.formData.dob = `${y}-${m}-${d}`; this.formData.retirement_date = `${y + 60}-${m}-${d}`; 
                    } 
                    if (this.formData.job_assumption_date) { 
                        let date = new Date(this.formData.job_assumption_date); date.setFullYear(date.getFullYear() + 2); 
                        this.formData.renewal_date = date.toISOString().split('T')[0]; 
                    } 
                },

                async uploadAvatar(e) {
                    const file = e.target.files[0]; if(!file) return;
                    this.loadingAvatar = true;
                    try {
                        const fileName = `${Date.now()}_avatar_${this.currentUser.mobile}.${file.name.split('.').pop()}`;
                        const { error: uploadError } = await client.storage.from('avatars').upload(fileName, file);
                        if(uploadError) throw uploadError;
                        const { data } = client.storage.from('avatars').getPublicUrl(fileName);
                        await client.from('users').update({ avatar_url: data.publicUrl }).eq('mobile', this.currentUser.mobile);
                        this.currentUser.avatar_url = data.publicUrl;
                        if(this.currentUser.role === 'manager') this.managerData.avatar_url = data.publicUrl; else this.fetchAgents();
                        this.formData.avatar_url = data.publicUrl; 
                        this.showAlert('ูุฌุงุญ โ', 'ุชู ุชุญุฏูุซ ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ ุจูุฌุงุญ', 'success');
                    } catch(err) { this.showAlert('ุฎุทุฃ ุจุงูุฑูุน', 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฑูุน ุงูุตูุฑุฉ', 'error'); }
                    finally { this.loadingAvatar = false; }
                },

                validateAndShowOath() {
                    if (!this.formData.avatar_url) return this.showAlert('ุตูุฑุฉ ููููุฏุฉ', 'ุฅุฑูุงู ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ ุฅูุฒุงูู.', 'error');
                    const nameParts = (this.formData.full_name || '').trim().split(/\s+/);
                    if (nameParts.length < 4) return this.showAlert('ุจูุงูุงุช ุบูุฑ ุตุญูุญุฉ', 'ูุฌุจ ุฅุฏุฎุงู ุงูุงุณู ุฑุจุงุนูุงู.', 'error');
                    const nid = (this.formData.nid || '').trim();
                    if (nid.length !== 14 || isNaN(nid)) return this.showAlert('ุจูุงูุงุช ุบูุฑ ุตุญูุญุฉ', 'ุงูุฑูู ุงููููู 14 ุฑูู.', 'error');
                    this.showOathModal = true;
                },

                async confirmAndSave() {
                    this.showOathModal = false; this.loading = true;
                    const payload = { full_name: this.formData.full_name, nid: this.formData.nid, dob: this.formData.dob || null, hiring_date: this.formData.hiring_date || null, job_assumption_date: this.formData.job_assumption_date || null, retirement_date: this.formData.retirement_date || null, renewal_date: this.formData.renewal_date || null, agent_assignment: this.formData.agent_assignment || null, job_status: this.formData.job_status || null };
                    const { error } = await client.from('users').update(payload).eq('mobile', this.currentUser.mobile);
                    if (error) { this.loading = false; return this.showAlert('ุฎุทุฃ', 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ.', 'error'); }
                    
                    if (this.currentUser.role === 'manager') { await client.from('schools').update({ manager_status: this.school.manager_status }).eq('id', this.school.id); }

                    this.currentUser = { ...this.currentUser, ...payload };
                    if(this.currentUser.role === 'manager') { this.managerData = { ...this.currentUser }; } else { await this.fetchAgents(); }
                    this.loading = false; this.isEditingForm = false; 
                    this.showAlert('ุชู ุงูุชุณุฌูู ุจูุฌุงุญ โ', 'ุชู ุญูุธ ุจูุงูุงุชู ุจูุฌุงุญ.', 'success');
                },

                async addNewAgent() { 
                    if (!this.newAgentMobile || this.newAgentMobile.length !== 11) return this.showAlert('ุฎุทุฃ', 'ุฃุฏุฎู ุฑูู ููุจุงูู 11 ุฑููุงู ุตุญูุญุงู.', 'error');
                    this.loadingAgents = true; const s_id = this.currentUser.school_id;
                    const newObj = { mobile: this.newAgentMobile, school_id: s_id, role: 'agent', pin: '0000', full_name: 'ุจุงูุชุธุงุฑ ุงุณุชููุงู ุงูุจูุงูุงุช' };
                    const { error } = await client.from('users').insert([newObj]); 
                    if (error) { this.loadingAgents = false; return this.showAlert('ุฎุทุฃ', 'ุงูุฑูู ูุณุฌู ูุณุจูุงู ุฃู ุฎุทุฃ ุจุงูุงุชุตุงู.', 'error'); }
                    
                    this.schoolAgents = [...this.schoolAgents, newObj]; 
                    this.newAgentMobile = ''; this.loadingAgents = false; 
                    this.showAlert('ูุฌุงุญ โ', 'ุชู ุฅุถุงูุฉ ุงููููู ุจูุฌุงุญ. ููููู ุงูุขู ุงูุฏุฎูู ูุชุณุฌูู ุจูุงูุงุชู.', 'success'); 
                },
                
                async removeAgent(mobile) { 
                    if (!confirm('ุญุฐู ูุฐุง ุงููููู ููุงุฆูุงูุ')) return; 
                    this.schoolAgents = this.schoolAgents.filter(a => a.mobile !== mobile); 
                    await client.from('users').delete().eq('mobile', mobile); 
                },

                async submitRequest() {
                    if (!this.requestForm.statement) return this.showAlert('ุชูุจูู', 'ูุฑุฌู ูุชุงุจุฉ ุงูุทูุจ', 'error');
                    this.loading = true; let fileUrl = null;
                    try {
                        if (this.requestForm.file) {
                            const file = this.requestForm.file; const fileName = `${Date.now()}_doc_${this.school.id}.${file.name.split('.').pop()}`;
                            await client.storage.from('requests_files').upload(fileName, file);
                            fileUrl = client.storage.from('requests_files').getPublicUrl(fileName).data.publicUrl;
                        }
                        await client.from('coordination_requests').insert([{ school_id: this.school.id, statement: this.requestForm.statement, file_url: fileUrl }]);
                        this.showAlert('ุชู ุงูุฅุฑุณุงู', 'ุชู ุฅุฑุณุงู ุงูุทูุจ ููุชูุณูู! ๐', 'success');
                        this.requestForm.statement = ''; this.requestForm.file = null; 
                        this.fetchRequests();
                        setTimeout(() => { this.currentView = 'menu'; }, 2000);
                    } catch (err) { this.showAlert('ุฎุทุฃ', 'ุญุฏุซ ุฎุทุฃ ุจุงูุฑูุน', 'error'); } finally { this.loading = false; }
                },

                async exportStatsToAdmin() {
                    if (!this.school.manager_status && this.currentUser.role === 'manager') return this.showAlert('ุฎุทุฃ', 'ูุฑุฌู ุชุญุฏูุฏ ุงููููู ุงููุธููู ูููุฏูุฑ ุฃููุงู.', 'error');
                    this.sendingReport = true;
                    try {
                        await client.from('schools').update({ teachers_count: this.school.teachers_count || 0, admins_count: this.school.admins_count || 0, workers_count: this.school.workers_count || 0, classrooms_count: this.school.classrooms_count || 0, students_count: this.school.students_count || 0, female_students_count: this.school.female_students_count || 0, manager_status: this.school.manager_status }).eq('id', this.school.id);
                        let agentsText = '';
                        if (this.schoolAgents.length > 0) { this.schoolAgents.forEach((a, i) => { agentsText += `๐จโ๐ซ ุงููููู ${i + 1} (${a.agent_assignment || 'ุจุฏูู'}): [${a.job_status || 'ูู ูุญุฏุฏ'}] - ${a.full_name || 'ุบูุฑ ูุณุฌู'}\n`; }); } else { agentsText = '๐จโ๐ซ ูุง ููุฌุฏ ูููุงุก.\n'; }
                        const reportText = `๐ ุฅุญุตุงุก ุงููุฏุฑุณุฉ ุงูุดุงูู\n-----------------------------------------\n๐ซ ูุฏุฑุณุฉ: ${this.school.name}\n-----------------------------------------\n๐จโ๐ผ ุงููุฏูุฑ: [${this.school.manager_status}] - ${this.managerData.full_name || 'ุบูุฑ ูุณุฌู'}\n${agentsText}\n-----------------------------------------\n๐ฅ ููุฉ ุงูุนูู:\n๐จโ๐ซ ุงููุนูููู: ${this.school.teachers_count || 0} | ๐จโ๐ป ุงูุฅุฏุงุฑููู: ${this.school.admins_count || 0} | ๐งน ุงูุนูุงู: ${this.school.workers_count || 0}\n-----------------------------------------\n๐ ุฃุนุฏุงุฏ ุงูุทูุงุจ ูุงููุตูู:\n๐ฆ ุงูุจููู: ${this.school.students_count || 0} | ๐ง ุงูุจูุงุช: ${this.school.female_students_count || 0} | ๐ช ุงููุตูู: ${this.school.classrooms_count || 0}`;
                        await client.from('coordination_requests').insert([{ school_id: this.school.id, statement: reportText }]);
                        this.showAlert('ุชู ุจูุฌุงุญ โ', 'ุชู ุฅุฑุณุงู ุงูุฅุญุตุงุก ุฅูู ุงูุชูุณูู.', 'success');
                    } catch (err) { this.showAlert('ุฎุทุฃ', 'ุญุฏุซ ุฎุทุฃ ุจุงูุชุตุฏูุฑ.', 'error'); }
                    this.sendingReport = false;
                },

                logout() { localStorage.clear(); window.location.href = 'login.html'; }
            }
        }
    </script>
</body>
</html>
