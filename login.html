<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… - Ø¥Ø¯Ø§Ø±Ø© Ø³ÙˆÙ‡Ø§Ø¬</title>
    <script src="https://cdn.tailwindcss.com"></script><link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" /><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script><script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #141A32; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #E8EDEB; position: relative; overflow: hidden; padding-top: 60px; padding-bottom: 5vh; }
        body::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: radial-gradient(circle at 50% 50%, rgba(214, 140, 41, 0.05) 0%, rgba(11, 15, 30, 1) 100%); z-index: 0; }
        .glass-box { background: rgba(20, 26, 50, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(214, 140, 41, 0.3); border-radius: 1.5rem; box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.5); z-index: 1; width: 90%; max-width: 380px; }
        .pin-box { width: 3.5rem; height: 4rem; background-color: #ffffff; color: #141A32; font-size: 1.8rem; font-weight: 900; text-align: center; border-radius: 0.75rem; border: 2px solid #cbd5e1; transition: all 0.2s; }
        .pin-box:focus { border-color: #D68C29; outline: none; box-shadow: 0 0 0 3px rgba(214, 140, 41, 0.3); transform: translateY(-2px); }
        .input-light { background-color: #ffffff !important; color: #1e293b !important; border: 2px solid #cbd5e1; font-weight: 800; }
        .input-light:focus { border-color: #D68C29; outline: none; box-shadow: 0 0 0 3px rgba(214, 140, 41, 0.3); }
        .btn-gold { background: linear-gradient(135deg, #D68C29 0%, #B4731D 100%); border: none; color: white; transition: all 0.3s; }
        .btn-gold:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(214, 140, 41, 0.4); }
        
        .role-container { background: rgba(11, 15, 30, 0.7); padding: 8px; border-radius: 1.2rem; border: 1px solid rgba(255,255,255,0.05); box-shadow: inset 0 4px 8px rgba(0,0,0,0.6); }
        .role-option { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: #8892B0; border: 1px solid rgba(255,255,255,0.05); background: rgba(255, 255, 255, 0.03); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .role-option.active { background: linear-gradient(135deg, #D68C29 0%, #B4731D 100%); color: white; box-shadow: 0 8px 20px rgba(214, 140, 41, 0.4), inset 0 2px 2px rgba(255,255,255,0.3); transform: translateY(-4px); border-color: transparent; }
        .role-option.inactive:hover { color: #fff; background: rgba(255,255,255,0.08); transform: translateY(-1px); }

        .marquee-container { width: 100%; overflow: hidden; background: rgba(11, 15, 30, 0.95); border-bottom: 2px solid #D68C29; padding: 8px 0; position: fixed; top: 0; left: 0; z-index: 9999; display: block; direction: rtl; } .marquee-content { display: inline-block; white-space: nowrap; font-weight: 800; color: #F5C678; animation: scroll-marquee var(--marquee-speed) linear infinite var(--marquee-dir); font-size: var(--marquee-size); padding: 0 20px; } @keyframes scroll-marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100vw); } }
        
        .animated-title-wrapper { position: relative; height: 40px; display: flex; justify-content: center; align-items: center; width: 100%; overflow: visible; margin-bottom: 5px;}
        .text-slide-1 { position: absolute; animation: fadeSwap1 8s infinite cubic-bezier(0.4, 0, 0.2, 1); text-shadow: 0 4px 15px rgba(245, 198, 120, 0.3); }
        .text-slide-2 { position: absolute; animation: fadeSwap2 8s infinite cubic-bezier(0.4, 0, 0.2, 1); text-shadow: 0 4px 15px rgba(214, 140, 41, 0.3); }

        @keyframes fadeSwap1 { 0%, 40% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); } 48%, 92% { opacity: 0; transform: translateY(-15px) scale(0.95); filter: blur(4px); } 100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); } }
        @keyframes fadeSwap2 { 0%, 40% { opacity: 0; transform: translateY(15px) scale(0.95); filter: blur(4px); } 48%, 92% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); } 100% { opacity: 0; transform: translateY(-15px) scale(0.95); filter: blur(4px); } }

        /* ---------- ØªØµÙ…ÙŠÙ… Ø²Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¯Ø§Ø¦Ø±ÙŠ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰) ---------- */
        .whatsapp-floating-btn {
            position: fixed;
            top: 65px; /* Ø£Ø³ÙÙ„ Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù…Ø¨Ø§Ø´Ø±Ø© */
            left: 20px; /* ÙÙŠ Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø± */
            background-color: #25D366;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 500;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .whatsapp-floating-btn:hover {
            transform: scale(1.1) rotate(-5deg);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6);
            background-color: #20BA56;
        }
        .whatsapp-icon { width: 28px; height: 28px; fill: currentColor; }
        /* ----------------------------------------------------------- */

        [x-cloak] { display: none !important; }
    </style>
</head>
<body x-data="loginApp()" x-init="initData()" :style="`--marquee-speed: ${marquee.speed}s; --marquee-dir: ${marquee.direction}; --marquee-size: ${marquee.size};`">
    
    <div x-show="alertModal.show" class="fixed inset-0 z-[99999] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" x-cloak x-transition><div class="bg-white w-full max-w-sm p-8 rounded-3xl shadow-2xl text-center transform transition-all border-t-8" :class="alertModal.type === 'success' ? 'border-green-500' : 'border-red-500'"><div class="text-6xl mb-4" x-text="alertModal.type === 'success' ? 'âœ…' : 'âš ï¸'"></div><h3 class="text-2xl font-black text-slate-800 mb-2" x-text="alertModal.title"></h3><p class="text-slate-600 font-bold mb-6 text-sm" x-text="alertModal.message"></p><button @click="closeAlert()" :class="`btn w-full text-white font-black text-lg h-12 rounded-xl border-none ${alertModal.type === 'success' ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'}`">Ø­Ø³Ù†Ø§Ù‹</button></div></div>
    
    <div class="marquee-container shadow-lg" x-show="marquee.text !== ''"><button @click="showPinModal = true" class="absolute right-2 top-1/2 transform -translate-y-1/2 z-50 bg-[#141A32]/80 hover:bg-[#D68C29] border border-[#D68C29]/50 p-1.5 rounded-lg text-lg transition-all duration-300">âš™ï¸</button><div class="marquee-content" x-text="marquee.text"></div></div>
    
    <a href="https://wa.me/201030302005" target="_blank" class="whatsapp-floating-btn" title="Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ">
        <svg class="whatsapp-icon" viewBox="0 0 24 24"><path d="M12.012 2c-5.506 0-9.989 4.478-9.99 9.984a9.964 9.964 0 001.333 4.993L2 22l5.233-1.237a9.994 9.994 0 004.779 1.217h.004c5.505 0 9.988-4.478 9.989-9.984 0-2.669-1.037-5.176-2.926-7.066A9.924 9.924 0 0012.012 2zm0 16.852h-.003a8.318 8.318 0 01-4.244-1.157l-.304-.18-3.15.745.84-3.074-.197-.314A8.291 8.291 0 013.684 11.98c.002-4.582 3.738-8.313 8.33-8.314 2.222 0 4.312.865 5.88 2.436a8.315 8.315 0 012.436 5.886c-.001 4.583-3.738 8.315-8.318 8.316zm4.567-6.236c-.25-.125-1.482-.733-1.713-.816-.23-.084-.399-.125-.567.125-.168.25-.65.816-.798.983-.149.167-.298.188-.548.063-.25-.125-1.057-.39-2.015-1.196-.745-.626-1.25-1.4-1.398-1.65-.148-.25-.016-.385.11-.51.112-.11.25-.292.373-.438.125-.146.167-.25.25-.417.084-.167.042-.313-.021-.438-.063-.125-.567-1.366-.777-1.87-.204-.492-.412-.425-.567-.433l-.485-.008c-.168 0-.441.063-.672.313-.23.25-.882.861-.882 2.1 0 1.238.903 2.434 1.028 2.6.125.167 1.77 2.7 4.285 3.733.599.245 1.067.391 1.433.5.602.192 1.15.165 1.583.1.484-.074 1.482-.606 1.692-1.193.21-.587.21-1.088.148-1.193-.063-.104-.23-.166-.48-.291z"></path></svg>
    </a>

    <div class="mb-4 text-center z-10 mt-2">
        <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center p-2 border-2 border-[#D68C29] mx-auto mb-4 shadow-lg"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a6/Coat_of_arms_of_Egypt_%28Official%29.svg/1200px-Coat_of_arms_of_Egypt_%28Official%29.svg.png" class="w-full h-full object-contain"></div>
        <div class="animated-title-wrapper w-full px-2">
            <h1 class="text-2xl md:text-3xl font-black text-[#F5C678] text-slide-1 whitespace-nowrap">Ø¥Ø¯Ø§Ø±Ø© Ø³ÙˆÙ‡Ø§Ø¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h1>
            <h1 class="text-xl md:text-2xl font-black text-[#D68C29] text-slide-2 whitespace-nowrap">ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ ÙˆØ§Ù„Ø«Ø§Ù†ÙˆÙŠ</h1>
        </div>
    </div>
    
    <div class="glass-box p-6 md:p-8 text-center border-t-8 border-[#D68C29]" x-show="!showSetupModal">
        <div class="flex gap-2 mb-6 role-container">
            <label :class="`cursor-pointer flex-1 py-3 rounded-lg flex items-center justify-center role-option ${role === 'manager' ? 'active' : 'inactive'}`"><input type="radio" value="manager" x-model="role" class="hidden"><span class="font-black text-lg">Ù…Ø¯ÙŠØ±</span></label>
            <label :class="`cursor-pointer flex-1 py-3 rounded-lg flex items-center justify-center role-option ${role === 'agent' ? 'active' : 'inactive'}`"><input type="radio" value="agent" x-model="role" class="hidden"><span class="font-black text-lg">ÙˆÙƒÙŠÙ„</span></label>
            <label :class="`cursor-pointer flex-1 py-3 rounded-lg flex items-center justify-center role-option ${role === 'admin' ? 'active' : 'inactive'}`"><input type="radio" value="admin" x-model="role" class="hidden"><span class="font-black text-lg">Ù…Ø³Ø¦ÙˆÙ„</span></label>
        </div>
        
        <div class="space-y-4">
            <div class="text-right">
                <label class="text-xs font-bold text-white/80 block mb-1">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
                <input type="tel" x-model="mobile" @input="mobile = mobile.replace(/[^0-9]/g, '')" maxlength="11" dir="ltr" class="input w-full input-light h-12 text-center text-xl tracking-widest font-mono" placeholder="01xxxxxxxxx" autocomplete="off" data-lpignore="true">
            </div>
            
            <div class="text-right" x-show="role !== 'agent'" x-transition>
                <label class="text-xs font-bold text-white/80 block mb-1">ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <div class="flex justify-center gap-2 md:gap-3" dir="ltr" id="pin-container">
                    <input type="tel" maxlength="1" class="pin-box" @input="autoTab" @keydown.backspace="autoBack" autocomplete="off" data-lpignore="true">
                    <input type="tel" maxlength="1" class="pin-box" @input="autoTab" @keydown.backspace="autoBack" autocomplete="off" data-lpignore="true">
                    <input type="tel" maxlength="1" class="pin-box" @input="autoTab" @keydown.backspace="autoBack" autocomplete="off" data-lpignore="true">
                    <input type="tel" maxlength="1" class="pin-box" @input="handleLast" @keydown.backspace="autoBack" autocomplete="off" data-lpignore="true">
                </div>
            </div>

            <div class="flex items-center gap-2 pt-1 pb-1 justify-start">
                <input type="checkbox" id="rememberMe" x-model="rememberMe" class="checkbox checkbox-sm border-[#D68C29] checked:border-[#D68C29] [--chkbg:#D68C29] [--chkfg:white] rounded" />
                <label for="rememberMe" class="text-sm text-slate-300 font-bold cursor-pointer select-none">ØªØ°ÙƒØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
            </div>
            
            <button @click="handleLogin" class="btn w-full h-14 btn-gold font-black text-xl rounded-xl shadow-lg mt-2">
                <span x-show="!loading">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ğŸ”</span>
                <span x-show="loading" class="loading loading-spinner text-white"></span>
            </button>
        </div>
    </div>

    <div x-show="showSetupModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"><div class="bg-white w-full max-w-md p-8 rounded-3xl shadow-2xl border-t-8 border-t-blue-600"><h3 class="text-2xl font-black text-slate-800 text-center mb-2">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</h3><p class="text-slate-500 text-center font-bold mb-6 text-sm">ÙŠØ±Ø¬Ù‰ ØªØ£ÙƒÙŠØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</p><div class="space-y-4"><template x-if="setupType === 'manager'"><div class="contents"><div><label class="block text-sm text-slate-700 font-bold mb-1">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label><select x-model="setup.stage" class="select w-full input-light"><option value="Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="Ø«Ø§Ù†ÙˆÙŠ">Ø«Ø§Ù†ÙˆÙŠ</option></select></div><div><label class="block text-sm text-slate-700 font-bold mb-1">Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label><select x-model="setup.schoolId" class="select w-full input-light"><option value="">-- Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³ØªÙƒ --</option><template x-for="s in filteredSchools" :key="s.id"><option :value="s.id" x-text="s.name"></option></template></select></div></div></template><div class="bg-red-50 p-4 rounded-xl border border-red-200 mt-4"><label class="block text-sm text-red-700 font-bold mb-1 text-center">ÙƒÙˆØ¯ Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</label><input type="password" x-model="setup.newPin" maxlength="4" class="input w-full input-light border-red-300 h-14 text-center tracking-widest text-2xl" placeholder="4 Ø£Ø±Ù‚Ø§Ù…" autocomplete="new-password"></div><button @click="saveSetup" class="btn w-full h-14 bg-blue-600 hover:bg-blue-700 text-white font-black text-xl rounded-xl mt-4"><span x-show="!loading">ØªÙØ¹ÙŠÙ„ ÙˆØ®Ø±ÙˆØ¬ âœ…</span><span x-show="loading" class="loading loading-spinner"></span></button><button @click="showSetupModal = false; loading = false;" class="btn w-full btn-ghost text-slate-500 mt-2">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>
    
    <div x-show="showPinModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 p-4" x-cloak><div class="bg-[#141A32] w-full max-w-sm p-6 rounded-3xl text-center border-t-8 border-[#D68C29]"><h3 class="text-xl font-black text-white mb-4">ğŸ” ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„ Ù„Ù„ØªØ­ÙƒÙ…</h3><input type="password" x-model="adminPinInput" maxlength="4" class="input w-full input-light text-center text-2xl font-black h-14 mb-4"><div class="flex gap-2"><button @click="verifyPin" class="btn flex-1 btn-gold font-black h-12 rounded-xl">ØªØ­Ù‚Ù‚</button><button @click="showPinModal = false; adminPinInput = ''" class="btn bg-slate-700 text-white border-none h-12 rounded-xl">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>
    
    <div x-show="showSettingsModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 p-4" x-cloak><div class="bg-[#141A32] w-full max-w-sm p-6 rounded-3xl text-right border-t-8 border-green-500"><h3 class="text-xl font-black text-white mb-6 text-center">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</h3><div class="space-y-4"><div><label class="text-white block mb-1">Ø§Ù„Ù†Øµ</label><textarea x-model="marquee.text" class="textarea w-full input-light h-24"></textarea></div><div><label class="text-white block mb-1">Ø§Ù„Ø³Ø±Ø¹Ø©</label><select x-model="marquee.speed" class="select w-full input-light"><option value="30">Ø¨Ø·ÙŠØ¡ Ø¬Ø¯Ø§Ù‹</option><option value="20">Ø¨Ø·ÙŠØ¡</option><option value="15">Ù…ØªÙˆØ³Ø·</option><option value="8">Ø³Ø±ÙŠØ¹</option></select></div><div class="grid grid-cols-2 gap-2"><div><label class="text-white block mb-1">Ø§Ù„Ø§ØªØ¬Ø§Ù‡</label><select x-model="marquee.direction" class="select w-full input-light"><option value="normal">ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø±</option><option value="reverse">ÙŠØ³Ø§Ø± Ù„Ù„ÙŠÙ…ÙŠÙ†</option></select></div><div><label class="text-white block mb-1">Ø§Ù„Ø­Ø¬Ù…</label><select x-model="marquee.size" class="select w-full input-light"><option value="1rem">ØµØºÙŠØ±</option><option value="1.2rem">Ù…ØªÙˆØ³Ø·</option><option value="1.6rem">ÙƒØ¨ÙŠØ±</option></select></div></div></div><div class="flex gap-2 mt-6"><button @click="saveMarqueeSettings" class="btn flex-1 bg-green-600 border-none text-white font-black h-12 rounded-xl">Ø­ÙØ¸</button><button @click="showSettingsModal = false" class="btn bg-slate-700 text-white h-12 rounded-xl border-none">Ø¥ØºÙ„Ø§Ù‚</button></div></div></div>

    <script>
        function loginApp() {
            const client = supabase.createClient('https://zjvnppqygcpccbtgebbq.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpqdm5wcHF5Z2NwY2NidGdlYmJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MTE1MjgsImV4cCI6MjA4Njk4NzUyOH0.LnUKMQkfh4YWMvUxO11wAw5ZY_k52PGAeVMVOky_ts0');
            return {
                role: 'manager', mobile: '', loading: false, showSetupModal: false, setupType: '', schoolsList: [], setup: { stage: 'Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ', schoolId: '', newPin: '' }, marquee: { text: '', speed: '15', direction: 'normal', size: '1.2rem' }, showPinModal: false, showSettingsModal: false, adminPinInput: '', rememberMe: false,
                
                alertModal: { show: false, type: 'success', title: '', message: '', action: null }, showAlert(title, message, type = 'success', action = null) { this.alertModal = { show: true, type, title, message, action }; }, closeAlert() { this.alertModal.show = false; if (this.alertModal.action) this.alertModal.action(); },
                
                async initData() { 
                    this.fetchMarqueeSettings(); 
                    let { data } = await client.from('schools').select('id, name, type').order('name'); 
                    if(data) this.schoolsList = data; 
                    this.loadSavedCredentials();
                },
                
                loadSavedCredentials() {
                    const savedMobile = localStorage.getItem('login_mobile');
                    const savedPin = localStorage.getItem('login_pin');
                    const savedRole = localStorage.getItem('login_role');
                    if (savedMobile) {
                        this.mobile = savedMobile;
                        if (savedRole) this.role = savedRole;
                        this.rememberMe = true;
                        if (this.role !== 'agent' && savedPin) {
                            setTimeout(() => {
                                const pinBoxes = document.querySelectorAll('.pin-box');
                                for (let i = 0; i < savedPin.length; i++) {
                                    if(pinBoxes[i]) pinBoxes[i].value = savedPin[i];
                                }
                            }, 100); 
                        }
                    }
                },

                handleRememberMe(finalPin) {
                    if (this.rememberMe) {
                        localStorage.setItem('login_mobile', this.mobile);
                        localStorage.setItem('login_pin', finalPin || '0000');
                        localStorage.setItem('login_role', this.role);
                    } else {
                        localStorage.removeItem('login_mobile');
                        localStorage.removeItem('login_pin');
                        localStorage.removeItem('login_role');
                    }
                },

                async fetchMarqueeSettings() { let { data } = await client.from('settings').select('*').eq('id', 1).maybeSingle(); if (data && data.marquee_text) { this.marquee.text = data.marquee_text; this.marquee.speed = data.marquee_speed || '15'; this.marquee.direction = data.marquee_direction || 'normal'; this.marquee.size = data.marquee_size || '1.2rem'; } },
                verifyPin() { if (this.adminPinInput === '5555') { this.showPinModal = false; this.showSettingsModal = true; } else { this.showAlert('Ø®Ø·Ø£', 'ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„ Ø®Ø§Ø·Ø¦', 'error'); } this.adminPinInput = ''; },
                async saveMarqueeSettings() { await client.from('settings').upsert({ id: 1, marquee_text: this.marquee.text, marquee_speed: this.marquee.speed, marquee_direction: this.marquee.direction, marquee_size: this.marquee.size }); this.showAlert('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­', 'success'); this.showSettingsModal = false; },
                get filteredSchools() { return this.schoolsList.filter(s => s.type === this.setup.stage); },
                autoTab(e) { e.target.value = e.target.value.replace(/[^0-9]/g, ''); if (e.target.value && e.target.nextElementSibling) e.target.nextElementSibling.focus(); }, 
                
                handleLast(e) { 
                    this.autoTab(e); 
                    const fullPin = this.getPin();
                    if (fullPin.length === 4 && this.mobile.length === 11 && this.role !== 'agent') { 
                        e.target.blur(); 
                        this.handleLogin(); 
                    } 
                }, 
                
                autoBack(e) { if (!e.target.value && e.target.previousElementSibling) e.target.previousElementSibling.focus(); }, getPin() { return Array.from(document.querySelectorAll('.pin-box')).map(i => i.value).join(''); },
                
                async handleLogin() {
                    if (!this.mobile) return this.showAlert('ØªÙ†Ø¨ÙŠÙ‡', 'Ø¨Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„', 'error');
                    if (this.mobile.length !== 11) return this.showAlert('ØªÙ†Ø¨ÙŠÙ‡', 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙƒÙˆÙ† Ù…Ù† 11 Ø±Ù‚Ù…Ø§Ù‹', 'error');
                    
                    this.loading = true;

                    if (this.role === 'agent') {
                        let { data: user, error } = await client.from('users').select('*').eq('mobile', this.mobile).eq('role', 'agent').maybeSingle();
                        this.loading = false;
                        
                        if (error || !user) {
                            localStorage.removeItem('login_mobile');
                            localStorage.removeItem('login_role');
                            return this.showAlert('Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„', 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙƒÙˆÙƒÙŠÙ„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹.', 'error');
                        }
                        
                        this.handleRememberMe('');
                        window.location.href = `madrasa.html?uid=${this.mobile}`;
                        return;
                    }

                    const finalPin = this.getPin(); 
                    if (finalPin.length !== 4) { this.loading = false; return this.showAlert('ØªÙ†Ø¨ÙŠÙ‡', 'Ø¨Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙˆØ± (4 Ø£Ø±Ù‚Ø§Ù…)', 'error'); }
                    
                    if (this.role === 'admin') { 
                        if (finalPin === '5555') {
                            this.handleRememberMe(finalPin); 
                            window.location.href = 'admin_dashboard.html'; 
                        } else {
                            this.showAlert('Ø®Ø·Ø£', 'ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„ Ø®Ø·Ø£', 'error'); 
                        }
                        this.loading = false; return; 
                    }
                    
                    let { data: user, error: mgrError } = await client.from('users').select('*').eq('mobile', this.mobile).maybeSingle();

                    if (finalPin === '0000' && this.role === 'manager') { 
                        if (user && user.pin && user.pin !== '0000') { 
                            this.loading = false; 
                            return this.showAlert('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙØ¹Ù„ØŒ Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ ÙˆÙ„Ø§ ØªØ³ØªØ®Ø¯Ù… 0000', 'error'); 
                        } else { 
                            this.loading = false; 
                            this.setupType = 'manager'; 
                            this.showSetupModal = true; 
                            return; 
                        } 
                    }
                    
                    if (mgrError || !user) {
                        localStorage.removeItem('login_mobile');
                        localStorage.removeItem('login_pin');
                        this.loading = false; 
                        return this.showAlert('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…', 'error'); 
                    }

                    let isPinCorrect = (user.pin === finalPin);
                    if (!isPinCorrect && this.role === 'manager' && user.school_id) { 
                        let { data: school } = await client.from('schools').select('manager_pin').eq('id', user.school_id).maybeSingle(); 
                        if (school && school.manager_pin === finalPin) { 
                            isPinCorrect = true; 
                            await client.from('users').update({ pin: finalPin }).eq('mobile', this.mobile); 
                        } 
                    }
                    
                    if (!isPinCorrect || user.role !== this.role) { 
                        this.showAlert('Ø®Ø·Ø£', 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error'); 
                        this.loading = false; return; 
                    }
                    
                    this.handleRememberMe(finalPin);
                    window.location.href = `madrasa.html?uid=${this.mobile}`;
                },
                
                async saveSetup() {
                    if (!this.setup.newPin || this.setup.newPin === '0000') return this.showAlert('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ ØºÙŠØ± 0000', 'error');
                    this.loading = true; let dbError = null;
                    if (this.setupType === 'manager') {
                        if (!this.setup.schoolId) { this.loading = false; return this.showAlert('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©', 'error'); }
                        await client.from('schools').update({ manager_pin: this.setup.newPin }).eq('id', this.setup.schoolId);
                        let { data: existing } = await client.from('users').select('id').eq('mobile', this.mobile).maybeSingle();
                        if (existing) { let { error } = await client.from('users').update({ school_id: this.setup.schoolId, role: 'manager', pin: this.setup.newPin }).eq('mobile', this.mobile); dbError = error; } 
                        else { let { error } = await client.from('users').insert([{ mobile: this.mobile, school_id: this.setup.schoolId, role: 'manager', pin: this.setup.newPin }]); dbError = error; }
                    } 
                    this.loading = false; if (dbError) return this.showAlert('Ø®Ø·Ø£', 'Ø®Ø·Ø£ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    this.showAlert('ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ âœ…', 'Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„ÙƒØŒ Ø§Ø¯Ø®Ù„ Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯.', 'success', () => { window.location.reload(); });
                }
            }
        }
    </script>
</body>
</html>